<script type="module">
    // =========================
    // CONFIGURAÇÃO DO FIREBASE
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDocs, getDoc, query, where, orderBy, Timestamp, updateDoc, setDoc, documentId, addDoc, serverTimestamp, deleteDoc, deleteField, writeBatch, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // =========================
    // VARIÁVEIS GLOBAIS
    // =========================
    let app, db, auth;
    let timerInterval;
    let segundosCorridos = 0;
    let tarefaAtualId = null; 
    let graficoPizza = null;
    let graficoDesempenhoModos = null;
    let graficoLinhaModos = null;
    let metaAcertosGlobal = 0;
    const modalCorpo = document.getElementById('modal-corpo');
    let questoesDoSimulado = [];
    let questaoAtualIndex = 0;
    let pontuacao = 0;
    let _db_r, _userId_r, _appId_r, _temaRedacaoAtual;

    // ===============================================
    // FUNÇÕES UTILITÁRIAS E AUXILIARES (MOVidas PARA CIMA)
    // ===============================================
    function showNotification(message, type = 'success') {
        const container = document.getElementById('notification-container');
        if (!container) return;
        const notif = document.createElement('div');
        notif.className = `p-4 text-white ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} rounded-lg shadow-md fade-in`;
        notif.textContent = message;
        container.appendChild(notif);
        setTimeout(() => { notif.classList.add('fade-out'); notif.addEventListener('animationend', () => notif.remove()); }, 3000);
    }

    function abrirModal(modalId) { 
        const modal = document.getElementById(modalId);
        if(modal) modal.classList.remove('hidden'); 
    }

    function fecharModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        const content = modal.querySelector('.fade-in');
        if (content) {
            content.classList.add('fade-out');
            content.addEventListener('animationend', () => { modal.classList.add("hidden"); content.classList.remove('fade-out'); }, { once: true });
        } else { 
            modal.classList.add("hidden");
        }
    }

    async function atualizarPerfilPublico(config) {
        const { db, appId, userId } = config;
        const user = auth.currentUser;
        if (!user) return;
        
        const publicProfileRef = doc(db, `artifacts/${appId}/public/data/usuarios`, userId);
        try {
            await setDoc(publicProfileRef, {
                nome: user.email, 
                uid: userId,
                lastSeen: serverTimestamp()
            }, { merge: true });
        } catch (e) {
            handleFirestoreError(e, "Atualizar Perfil Público");
        }
    }

    function handleFirestoreError(error, context) {
        console.error(`Erro de Firestore em '${context}':`, error);
        if (error.code === 'permission-denied' || error.code === 'missing-or-insufficient-permissions') {
            const errorContainer = document.getElementById('global-error-container');
            const errorMessage = document.getElementById('global-error-message');
            errorMessage.textContent = `Falha na operação '${context}'. Parece que as Regras de Segurança do seu Firestore estão bloqueando a ação. Por favor, verifique se as regras corretas foram aplicadas ao seu projeto no Console do Firebase.`;
            errorContainer.classList.remove('hidden');
        } else {
            showNotification(`Erro em '${context}': ${error.message}`, 'error');
        }
    }

    function getDragAfterElement(container, y) { 
        const draggableElements = [...container.querySelectorAll('.priority-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => { 
            const box = child.getBoundingClientRect(); 
            const offset = y - box.top - box.height / 2; 
            if (offset < 0 && offset > closest.offset) { 
                return { offset: offset, element: child }; 
            } else { 
                return closest; 
            } 
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function getDateRange(periodo) { 
        const agora = new Date(); 
        let dataInicio;
        if (periodo === 'semana') dataInicio = new Date(agora.setDate(agora.getDate() - 7));
        else if (periodo === 'mes') dataInicio = new Date(agora.setMonth(agora.getMonth() - 1)); 
        else dataInicio = new Date(0); 
        return Timestamp.fromDate(dataInicio);
    }

    // =========================
    // FUNÇÃO PRINCIPAL
    // =========================
    function iniciarAplicacao() {
        const hardcodedFirebaseConfig = {
          apiKey: "AIzaSyDqHXjI3lTXMgRWItxaP7An-JZe04YQ-Sg",
          authDomain: "gfconcursos-app.firebaseapp.com",
          projectId: "gfconcursos-app",
          storageBucket: "gfconcursos-app.firebasestorage.app",
          messagingSenderId: "615439428502",
          appId: "1:615439428502:web:b399549c3969e052098bb7"
        };
        let firebaseConfig = hardcodedFirebaseConfig;

        if (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') {
            try {
                const envConfig = JSON.parse(__firebase_config);
                if (envConfig.projectId) firebaseConfig = envConfig;
            } catch (e) {
                console.warn("Configuração do ambiente (__firebase_config) é inválida. Usando configuração fixa.");
            }
        }
        
        if (!firebaseConfig.projectId) {
            console.error("Nenhuma configuração válida do Firebase foi encontrada.");
            document.body.innerHTML = '<h1>Erro Crítico: Configuração do Firebase ausente.</h1>';
            return;
        }

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Erro ao inicializar Firebase:", e);
            document.body.innerHTML = `<h1>Erro ao inicializar Firebase: ${e.message}</h1>`;
            return;
        }

        configurarNavegacaoAbas();
        iniciarAutenticacao();
    }
    
    // =========================
    // NAVEGAÇÃO POR ABAS E UI
    // =========================
    function configurarNavegacaoAbas() {
        const tabsContainer = document.getElementById('tabs-container');
        if (!tabsContainer) return;

        const tabButtons = tabsContainer.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        document.getElementById('menu-toggle').addEventListener('click', () => {
            document.getElementById('nav-menu').classList.toggle('hidden');
        });
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabContents.forEach(content => {
                     if (content.id === `tab-content-${tab}`) content.classList.remove('hidden');
                    else content.classList.add('hidden');
                });
                if (window.innerWidth < 768) document.getElementById('nav-menu').classList.add('hidden');
            });
        });
        document.getElementById('show-signup').addEventListener('click', (e) => {
          e.preventDefault();
          document.getElementById('login-view').classList.add('hidden');
          document.getElementById('signup-view').classList.remove('hidden');
        });
        document.getElementById('show-login').addEventListener('click', (e) => {
          e.preventDefault();
          document.getElementById('signup-view').classList.add('hidden');
          document.getElementById('login-view').classList.remove('hidden');
        });
    }

    // =========================
    // AUTENTICAÇÃO E INICIALIZAÇÃO
    // =========================
    function iniciarAutenticacao() {
        document.getElementById('btn-login').addEventListener('click', handleLogin);
        document.getElementById('btn-signup').addEventListener('click', handleSignUp);
        document.getElementById('btn-logout').addEventListener('click', handleLogout);

        onAuthStateChanged(auth, async (user) => {
            const authContainer = document.getElementById('auth-container');
            const appWrapper = document.getElementById('app-wrapper');

            if (user) {
                authContainer.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                document.getElementById('user-info').textContent = `Bem-vindo, ${user.email}`;
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const config = { db, auth, appId, userId: user.uid };
           
                document.querySelector('.tab-button[data-tab="estudo"]').click();
                
                await inicializarApp(config);
                inicializarModuloCronograma(config);
                inicializarModuloRedacao(config);
            } else {
                authContainer.classList.remove('hidden');
                appWrapper.classList.add('hidden');
            }
        });
    }

    async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        if (!email || !password) {
            showNotification("Por favor, preencha e-mail e senha.", "error");
            return;
        }
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showNotification("Login bem-sucedido!", "success");
        } catch (error) {
            console.error("Erro de login:", error);
            showNotification(`Erro ao entrar: ${error.message}`, "error");
        }
    }

    async function handleSignUp() {
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        if (!email || !password) {
            showNotification("Por favor, preencha e-mail e senha.", "error");
            return;
        }
        if (password.length < 6) {
            showNotification("A senha deve ter pelo menos 6 caracteres.", "error");
            return;
        }
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showNotification("Conta criada com sucesso! Bem-vindo!", "success");
        } catch (error) {
            console.error("Erro de cadastro:", error.code);
            showNotification(`Erro ao cadastrar: ${error.message}`, "error");
        }
    }

    async function handleLogout() {
        try {
            await signOut(auth);
            showNotification("Você saiu com sucesso.", "success");
        } catch (error) {
            showNotification("Erro ao sair.", "error");
        }
    }

    // =========================
    // FUNÇÃO GERAL DE INICIALIZAÇÃO DOS MÓDULOS
    // =========================
    async function inicializarApp(config) {
        const { db, auth, appId, userId } = config;
        await atualizarPerfilPublico(config);

        await carregarSessaoPendente(config);

        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/perfil`, 'userData');
        const userDoc = await getDoc(userDocRef);
        if(userDoc.exists()) {
            const userData = userDoc.data();
            metaAcertosGlobal = userData.metaAcertos || 80;
            document.getElementById('meta-geral-horas').value = userData.metaGeralHoras || '';
            document.getElementById('ciclo-nome-input').value = userData.cicloAtualNome || 'Ciclo 1: Rumo à Aprovação (ALE-RO)';
            await carregarPrioridades(config, userData.prioridadeDisciplinas);
        } else {
            await carregarPrioridades(config, []);
        }
        
        const funcoesCarregamento = [
            () => carregarDisciplinas(config), () => carregarProgressoDisciplinas(config), () => carregarEvolucaoQuestoes(config),
            () => carregarRevisoes(config), () => carregarDesempenhoPorModo(config), () => carregarEvolucaoCronologicaPorModo(config),
            () => carregarEdital(config), () => carregarPerfil(config), () => carregarMedalhas(config), () => carregarRanking(config),
            () => carregarDesafios(config), () => carregarSimulados(config)
        ];
        
        for(const funcao of funcoesCarregamento) { try { await funcao(); } catch (error) { console.error(`Erro ao executar ${funcao.name}:`, error); } }

        document.getElementById('btn-cadastrar-disciplina-edital').addEventListener('click', () => handleCadastrarDisciplina(config));
        document.getElementById('btn-revisao-inteligente').addEventListener('click', () => iniciarRevisaoInteligente(config));
        document.getElementById('filtroPeriodoDesempenho').addEventListener('change', () => { carregarDesempenhoPorModo(config); carregarEvolucaoCronologicaPorModo(config); });
        document.getElementById('btnCompararMeta').addEventListener('click', () => toggleLinhaMeta());
        document.getElementById('btn-iniciar-pratica').addEventListener('click', () => { const idDisciplina = document.getElementById("seletorDisciplina").value; if (!idDisciplina) { alert("Por favor, escolha uma disciplina."); return; } iniciarSimulado(config, idDisciplina, null, null, 'pratica'); });
        document.getElementById('btn-download-relatorio').addEventListener('click', () => baixarRelatorioPDF(config));
        document.getElementById('btn-salvar-metas').addEventListener('click', () => salvarMetasEDistribuir(config));
        document.getElementById('btn-fechar-modal-questoes').addEventListener('click', () => fecharModal('modal-questoes'));
        document.getElementById('btn-encerrar-ciclo').addEventListener('click', () => handleEncerrarCiclo(config));
        
        document.getElementById('btn-toggle-sessao').addEventListener('click', () => toggleSessaoDeEstudo(config));
        
        document.getElementById('btn-confirmar-horas').addEventListener('click', () => {
            const horas = parseFloat(document.getElementById('modal-horas-input').value);
            if (horas > 0) {
                updateTimerDisplayFromHours(horas);
                document.getElementById('btn-toggle-sessao').disabled = false;
                fecharModal('modal-horas');
            } else {
                showNotification("Por favor, insira um valor de horas válido.", "error");
            }
        });
        document.getElementById('btn-cancelar-horas').addEventListener('click', () => fecharModal('modal-horas'));
    }
    
    // =========================
    // MÓDULO DE CRONOGRAMA
    // =========================

    function formatarTempo(totalSegundos) {
        const s = Math.max(0, totalSegundos);
        const horas = Math.floor(s / 3600);
        const minutos = Math.floor((s % 3600) / 60);
        const segundos = s % 60;
        return [horas, minutos, segundos]
            .map(v => v.toString().padStart(2, '0'))
            .join(':');
    }

    function updateTimerDisplayFromHours(horas) {
        const timerDisplay = document.getElementById('timer-display');
        segundosCorridos = (horas || 0) * 3600;
        timerDisplay.textContent = formatarTempo(segundosCorridos);
    }

    async function toggleSessaoDeEstudo(config) {
        const btn = document.getElementById('btn-toggle-sessao');
        const isRunning = timerInterval != null;

        if (isRunning) {
            clearInterval(timerInterval);
            timerInterval = null;
            btn.textContent = 'Retomar Estudo';
            btn.classList.remove('bg-red-600');
            btn.classList.add('bg-green-600');
            await salvarSessaoPendente(config);
        } else {
            if (tarefaAtualId === null) {
                showNotification("Nenhuma tarefa selecionada.", "error");
                return;
            }
            if (segundosCorridos <= 0) {
                showNotification("Tempo de estudo zerado. Selecione a tarefa novamente e defina as horas.", "error");
                return;
            }

            btn.textContent = 'Pausar Estudo';
            btn.classList.remove('bg-green-600');
            btn.classList.add('bg-red-600');

            timerInterval = setInterval(async () => {
                segundosCorridos--;
                document.getElementById('timer-display').textContent = formatarTempo(segundosCorridos);

                if (segundosCorridos <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    btn.textContent = 'Iniciar Estudo';
                    btn.classList.remove('bg-red-600');
                    btn.classList.add('bg-green-600');
                    btn.disabled = true;
                    showNotification("Sessão de estudo concluída!", "success");
                    await marcarTarefaComoConcluida(config);
                    await limparSessaoPendente(config); 
                }
            }, 1000);
        }
    }
    
    async function marcarTarefaComoConcluida(config) {
        if (!tarefaAtualId) return;
        try {
            const tarefaRef = doc(db, `artifacts/${config.appId}/users/${config.userId}/cronograma`, tarefaAtualId);
            await updateDoc(tarefaRef, { status: "concluido" });
            
            showNotification(`Tarefa marcada como concluída!`, "success");
            await carregarCronograma(config); 
            
            tarefaAtualId = null; 
            document.getElementById('cronometro-info-selecionada').classList.add('hidden');
            document.getElementById('cronometro-texto-info').textContent = 'Clique em uma tarefa no seu cronograma semanal para começar.';
            document.getElementById('cronometro-wrapper').classList.remove('p-2', 'border-2', 'border-yellow-400');

        } catch(error) {
            handleFirestoreError(error, "Marcar Tarefa como Concluída");
        }
    }
    
    async function selecionarTarefaParaEstudo(tarefaElement, config) {
        await limparSessaoPendente(config);
        
        const { tarefaId, materia, assunto } = tarefaElement.dataset;
        tarefaAtualId = tarefaId;
        
        document.getElementById('cronometro-disciplina-display').textContent = materia;
        document.getElementById('cronometro-assunto-display').textContent = assunto;
        
        document.getElementById('cronometro-texto-info').textContent = '';
        document.getElementById('cronometro-info-selecionada').classList.remove('hidden');
        document.getElementById('cronometro-wrapper').classList.remove('p-2', 'border-2', 'border-yellow-400');

        updateTimerDisplayFromHours(0);
        document.getElementById('btn-toggle-sessao').disabled = true;
        
        document.getElementById('modal-horas-input').value = 1;
        abrirModal('modal-horas');
    }

    async function salvarSessaoPendente(config) {
        if (!tarefaAtualId || segundosCorridos < 0) return;

        const materia = document.getElementById('cronometro-disciplina-display').textContent;
        const assunto = document.getElementById('cronometro-assunto-display').textContent;

        const sessaoRef = doc(db, `artifacts/${config.appId}/users/${config.userId}/sessao_pendente`, 'current_session');
        try {
            await setDoc(sessaoRef, {
                tarefaId: tarefaAtualId,
                materia: materia,
                assunto: assunto,
                segundosRestantes: segundosCorridos,
                timestamp: serverTimestamp()
            });
            console.log("Sessão pendente salva.");
        } catch (e) {
            handleFirestoreError(e, "Salvar Sessão Pendente");
        }
    }

    async function carregarSessaoPendente(config) {
        const sessaoRef = doc(db, `artifacts/${config.appId}/users/${config.userId}/sessao_pendente`, 'current_session');
        const sessaoDoc = await getDoc(sessaoRef);

        if (sessaoDoc.exists()) {
            const data = sessaoDoc.data();
            tarefaAtualId = data.tarefaId;
            segundosCorridos = data.segundosRestantes;

            document.getElementById('cronometro-disciplina-display').textContent = data.materia;
            document.getElementById('cronometro-assunto-display').textContent = data.assunto;
            document.getElementById('timer-display').textContent = formatarTempo(data.segundosRestantes);
            
            document.getElementById('cronometro-texto-info').textContent = 'Você tem uma sessão de estudo pendente.';
            document.getElementById('cronometro-info-selecionada').classList.remove('hidden');
            
            const btn = document.getElementById('btn-toggle-sessao');
            btn.textContent = 'Retomar Estudo';
            btn.disabled = false;
            
            document.getElementById('cronometro-wrapper').classList.add('p-2', 'border-2', 'border-yellow-400');
            showNotification("Sessão de estudo pendente carregada.", "success");
        }
    }

    async function limparSessaoPendente(config) {
        const sessaoRef = doc(db, `artifacts/${config.appId}/users/${config.userId}/sessao_pendente`, 'current_session');
        try {
            await deleteDoc(sessaoRef);
            console.log("Sessão pendente limpa.");
        } catch (e) {
            if (e.code !== 'not-found') {
                handleFirestoreError(e, "Limpar Sessão Pendente");
            }
        }
    }

    function inicializarModuloCronograma(config) {
        document.getElementById('form-cronograma').addEventListener('submit', (e) => adicionarTarefaCronograma(e, config));
        document.getElementById('materia-cronograma').addEventListener('change', (e) => handleMateriaChangeCronograma(e, config));
        
        const container = document.getElementById('container-dias-cronograma');
        container.addEventListener('click', (e) => {
            const tarefaElement = e.target.closest('.tarefa-cronograma-item');
            if (tarefaElement) {
                selecionarTarefaParaEstudo(tarefaElement, config);
            }
        });

        renderizarEstruturaDias();
        carregarCronograma(config);
        carregarDisciplinasNoCronograma(config);
    }

    function renderizarEstruturaDias() {
        const container = document.getElementById('container-dias-cronograma');
        if(!container) return;
        container.innerHTML = '';
        const dias = {
            "segunda": "Segunda-feira", "terca": "Terça-feira", "quarta": "Quarta-feira",
            "quinta": "Quinta-feira", "sexta": "Sexta-feira", "sabado": "Sábado", "domingo": "Domingo"
        };
        for (const diaId in dias) {
            const displayName = dias[diaId];
            container.innerHTML += `<div class="bg-gray-100 p-3 rounded-lg"><h3 class="font-semibold text-center border-b pb-2 mb-2">${displayName}</h3><div id="lista-tarefas-${diaId}" class="space-y-2"><p class="text-xs text-gray-400 text-center">Nenhuma tarefa.</p></div></div>`;
        }
    }

    async function adicionarTarefaCronograma(e, config) {
        e.preventDefault();
        const materiaSelect = document.getElementById('materia-cronograma');
        const materia = materiaSelect.options[materiaSelect.selectedIndex].text;
        const assuntoSelect = document.getElementById('assunto-cronograma');
        const assunto = assuntoSelect.value;
        const dia = document.getElementById('dia-cronograma').value;
        const horario = document.getElementById('horario-cronograma').value;

        if (!materia || materiaSelect.value === "" || !dia || !horario || !assunto) { 
            showNotification("Preencha todos os campos, incluindo matéria e assunto.", "error");
            return; 
        }
        try {
            const collectionPath = `artifacts/${config.appId}/users/${config.userId}/cronograma`;
            await addDoc(collection(config.db, collectionPath), { materia, assunto, dia, horario, usuarioId: config.userId, status: "pendente" });
            showNotification("Tarefa adicionada!");
            document.getElementById('form-cronograma').reset();
            document.getElementById('assunto-cronograma-container').classList.add('hidden');
            carregarCronograma(config);
        } catch (error) { handleFirestoreError(error, "Adicionar Tarefa ao Cronograma"); }
    }
    
    async function carregarCronograma(config) {
        renderizarEstruturaDias();
        const collectionPath = `artifacts/${config.appId}/users/${config.userId}/cronograma`;
        const q = query(collection(config.db, collectionPath), where("usuarioId", "==", config.userId));
        const querySnapshot = await getDocs(q);
        const tarefasPorDia = {};
        querySnapshot.forEach(doc => {
            const tarefa = { id: doc.id, ...doc.data() };
            if (!tarefasPorDia[tarefa.dia]) {
                tarefasPorDia[tarefa.dia] = [];
            }
            tarefasPorDia[tarefa.dia].push(tarefa);
        });
        for (const diaId in tarefasPorDia) {
            const containerTarefas = document.getElementById(`lista-tarefas-${diaId}`);
            if (containerTarefas) {
                containerTarefas.innerHTML = '';
                tarefasPorDia[diaId].sort((a, b) => a.horario.localeCompare(b.horario));
                tarefasPorDia[diaId].forEach(tarefa => {
                    const isConcluida = tarefa.status === 'concluido';
                    const div = document.createElement('div');
                    
                    const bgColorClass = isConcluida ? 'bg-green-100 border-l-4 border-green-500' : 'bg-white';
                    div.className = `tarefa-cronograma-item p-2 rounded shadow-sm flex justify-between items-center text-sm ${bgColorClass}`;
                    
                    div.dataset.tarefaId = tarefa.id;
                    div.dataset.materia = tarefa.materia;
                    div.dataset.assunto = tarefa.assunto;
                    div.dataset.dia = tarefa.dia;

                    div.innerHTML = `<div><p class="font-bold">${tarefa.horario} - ${tarefa.materia}</p><p class="text-xs text-gray-500 pl-1">${tarefa.assunto}</p></div>`;
                  
                  const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.className = "text-red-500 hover:text-red-700 font-bold text-lg px-2";
                    removeBtn.onclick = (e) => {
                        e.stopPropagation(); 
                        removerTarefaCronograma(tarefa.id, config);
                    };
      
                    div.appendChild(removeBtn);
                    containerTarefas.appendChild(div);
                });
            }
        }
    }

    async function removerTarefaCronograma(tarefaId, config) {
        try {
            const docPath = `artifacts/${config.appId}/users/${config.userId}/cronograma/${tarefaId}`;
            await deleteDoc(doc(config.db, docPath));
            showNotification("Tarefa removida.");
            carregarCronograma(config);
        } catch (error) { handleFirestoreError(error, "Remover Tarefa do Cronograma");
        }
    }

    // =========================
    // MÓDULO DE REDAÇÃO
    // =========================
    function inicializarModuloRedacao(config) {
        _db_r = config.db; _userId_r = config.userId; _appId_r = config.appId;
        carregarTemasRedacao_v2();
        carregarRedacoesSalvas_v2();
        document.getElementById("btn-fechar-escrever")?.addEventListener("click", () => fecharModal('modal-redacao'));
        document.getElementById("btn-fechar-ver")?.addEventListener("click", () => fecharModal('modal-ver-redacao'));
        document.getElementById("btn-salvar")?.addEventListener("click", salvarRedacao_v2);
        document.getElementById("btn-corrigir")?.addEventListener("click", corrigirRedacao_v2);
        document.getElementById("btn-imprimir")?.addEventListener("click", imprimirRedacao_v2);
    }
    async function carregarTemasRedacao_v2() {
        const temas = [{ titulo: "A influência das redes sociais no comportamento juvenil", ano: 2022, banca: "ENEM" }, { titulo: "Desafios da mobilidade urbana no Brasil", ano: 2021, banca: "Fuvest" }, { titulo: "O papel da tecnologia na educação contemporânea", ano: 2023, banca: "Unicamp" }];
        const container = document.getElementById("temas-redacao");
        if (!container) return;
        container.innerHTML = "";
        temas.forEach((tema) => {
            const div = document.createElement("div");
            div.className = "p-6 bg-white rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col";
            div.innerHTML = `<div class="flex-grow"><h3 class="text-lg font-semibold text-gray-900">${tema.titulo}</h3><p class="text-sm text-gray-500 mt-2">Ano: ${tema.ano} | Banca: ${tema.banca}</p></div><button class="escrever-redacao-btn mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 self-start transition-colors">Escrever Redação</button>`;
            div.querySelector(".escrever-redacao-btn").addEventListener("click", () => {
         
               _temaRedacaoAtual = tema.titulo;
                document.getElementById("titulo-redacao").textContent = tema.titulo;
                document.getElementById("texto-redacao").value = "";
                document.getElementById("resultado-correcao").innerHTML = "";
                document.getElementById("btn-imprimir").style.display = "none";
                abrirModal('modal-redacao');
            });
            container.appendChild(div);
        });
    }
    async function salvarRedacao_v2() {
        const texto = document.getElementById("texto-redacao").value.trim();
        if (!texto) { showNotification("Digite sua redação antes de salvar.", "error"); return; }
        try {
            const collectionPath = `artifacts/${_appId_r}/users/${_userId_r}/redacoes`;
            await addDoc(collection(_db_r, collectionPath), { tema: _temaRedacaoAtual, texto: texto, data: serverTimestamp(), usuarioId: _userId_r });
            showNotification("Redação salva com sucesso!");
            fecharModal('modal-redacao');
            carregarRedacoesSalvas_v2();
        } catch (erro) { handleFirestoreError(erro, "Salvar Redação"); }
    }
    async function carregarRedacoesSalvas_v2() {
        const container = document.getElementById("lista-redacoes-salvas-v2");
        if(!container) return;
        const collectionPath = `artifacts/${_appId_r}/users/${_userId_r}/redacoes`;
        const q = query(collection(_db_r, collectionPath), where("usuarioId", "==", _userId_r));
        try {
            const querySnapshot = await getDocs(q);
            container.innerHTML = "";
            if(querySnapshot.empty) { container.innerHTML = `<p class="text-gray-500">Nenhuma redação salva.</p>`; return; }
            querySnapshot.forEach((doc) => {
                const redacao = doc.data();
                const div = document.createElement("div");
                div.className = "p-4 bg-white rounded-lg shadow-sm flex justify-between items-center";
                div.innerHTML = `<div><h4 class="font-semibold text-gray-800">${redacao.tema}</h4><p class="text-sm text-gray-500">Salva em: ${redacao.data ? new Date(redacao.data.seconds * 1000).toLocaleDateString() : 'Data indisponível'}</p></div><button class="ver-redacao-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 text-sm transition">Ver</button>`;
                div.querySelector('.ver-redacao-btn').addEventListener('click', () => {
                    document.getElementById('ver-titulo-redacao').textContent = redacao.tema;
                    document.getElementById('ver-texto-redacao').textContent = redacao.texto;
                    abrirModal('modal-ver-redacao');
                });
                container.appendChild(div);
            });
        } catch(error) { handleFirestoreError(error, "Carregar Redações Salvas"); }
    }
    function corrigirRedacao_v2() {
        const texto = document.getElementById("texto-redacao").value.trim();
        if (!texto) { showNotification("Digite o texto antes de corrigir.", "error"); return; }
        let nota = 100; let observacoes = [];
        if (texto.length < 500) { nota -= 20; observacoes.push("O texto está um pouco curto."); }
        if (!/portanto|conclui-se|logo|enfim/i.test(texto)) { nota -= 15; observacoes.push("Reforce a conclusão com conectivos."); }
        if (texto.split(' ').length < 150) { nota -= 20; observacoes.push("Texto com menos de 150 palavras."); }
        if (nota > 90) { observacoes.push("Excelente estrutura!"); }
        if (nota < 0) nota = 0;
        document.getElementById("resultado-correcao").innerHTML = `<div class="mt-4 p-4 bg-gray-50 rounded-lg border"><h3 class="text-lg font-semibold mb-2 text-gray-800">Correção (IA Simples)</h3><p class="text-2xl font-bold text-blue-600">${nota}<span class="text-base font-normal text-gray-500">/100</span></p><ul class="list-disc ml-5 mt-3 text-gray-600 space-y-1">${observacoes.map(obs => `<li>${obs}</li>`).join("")}</ul></div>`;
        document.getElementById("btn-imprimir").style.display = "inline-block";
    }
    function imprimirRedacao_v2() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        pdf.setFontSize(16); pdf.text(`Tema: ${_temaRedacaoAtual}`, 10, 10);
        pdf.setFontSize(12);
        pdf.text(pdf.splitTextToSize(document.getElementById("texto-redacao").value, 180), 10, 20);
        pdf.save(`redacao-${_temaRedacaoAtual.replace(/\s/g, '_')}.pdf`);
        showNotification("Gerando PDF...");
    }

    // =========================
    // LÓGICA PRINCIPAL (RESTANTE)
    // =========================
    
    async function carregarDisciplinas(config) {
      const q = query(collection(db, `artifacts/${config.appId}/users/${config.userId}/disciplinas`), orderBy("nome"));
      const snapshot = await getDocs(q);
      const seletor = document.getElementById("seletorDisciplina");
      if (seletor) {
        seletor.innerHTML = '<option value="">-- Escolha uma disciplina --</option>';
      }
     
      if (snapshot.empty) {
          const msg = '<option value="">Cadastre disciplinas no Edital</option>';
          if (seletor) seletor.innerHTML = msg;
      } else {
          snapshot.forEach(doc => {
              const optionHTML = `<option value="${doc.id}">${doc.data().nome}</option>`;
              if (seletor) seletor.innerHTML += optionHTML;
          });
      }
      await carregarDisciplinasNoCronograma(config);
      
      const seletorDisciplinaEl = document.getElementById('seletorDisciplina');
      if (seletorDisciplinaEl) {
        seletorDisciplinaEl.addEventListener('change', () => carregarAssuntos(config));
      }
    }
    
    async function carregarDisciplinasNoCronograma(config) {
      const q = query(collection(db, `artifacts/${config.appId}/users/${config.userId}/disciplinas`), orderBy("nome"));
      const snapshot = await getDocs(q);
      const seletorCronograma = document.getElementById("materia-cronograma");
      seletorCronograma.innerHTML = '<option value="">-- Escolha uma matéria --</option>';
      if (snapshot.empty) {
          seletorCronograma.innerHTML = '<option value="">Cadastre disciplinas no Edital</option>';
      } else {
        snapshot.forEach(doc => {
            seletorCronograma.innerHTML += `<option value="${doc.id}">${doc.data().nome}</option>`;
        });
      }
    }
    
    async function carregarAssuntos(config) {
      const idDisciplina = document.getElementById("seletorDisciplina").value;
      const container = document.getElementById("listaAssuntos");
      if(!container) return;
      container.innerHTML = "";
      if (!idDisciplina) return;
      
      const disciplinaDoc = await getDoc(doc(db, `artifacts/${config.appId}/users/${config.userId}/disciplinas`, idDisciplina));
      if (!disciplinaDoc.exists()) return;
      const assuntos = disciplinaDoc.data().assuntos || {};
      
      if (Object.keys(assuntos).length === 0) {
        container.innerHTML = "<p class='text-slate-500 text-center'>Nenhum assunto cadastrado.<br>Adicione na aba 'Edital'.</p>";
        return;
      }

      for (const assuntoId in assuntos) {
        const a = assuntos[assuntoId];
        container.innerHTML += `<div class="border p-3 rounded-lg"><h4 class="font-bold text-lg">${a.nome}</h4><p class="text-sm text-gray-600 my-2">${a.resumo || 'Sem resumo.'}</p><button data-disciplina-id="${idDisciplina}" data-assunto-nome="${a.nome}" class="btn-praticar-assunto w-full bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold">Praticar por assunto</button></div>`;
      }
      document.querySelectorAll('.btn-praticar-assunto').forEach(btn => btn.addEventListener('click', (e) => iniciarSimulado(config, e.currentTarget.dataset.disciplinaId, e.currentTarget.dataset.assuntoNome, null, 'pratica')));
    }

    async function carregarEdital(config) {
        const { db, appId, userId } = config;
        const container = document.getElementById('edital-disciplinas-container');
        container.innerHTML = "<p class='text-slate-500 text-center'>Carregando edital...</p>";

        const q = query(collection(db, `artifacts/${appId}/users/${userId}/disciplinas`), orderBy("nome"));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            container.innerHTML = "<p class='text-slate-500 text-center'>Nenhuma disciplina cadastrada ainda. Adicione uma acima para começar.</p>";
            return;
        }

        container.innerHTML = '';
        snapshot.forEach(doc => {
            const disciplina = { id: doc.id, ...doc.data() };
            
            const disciplinaCard = document.createElement('div');
            disciplinaCard.className = 'border p-4 rounded-lg bg-white';
            
            let assuntosHTML = '<ul class="list-disc ml-5 mt-2 space-y-1 text-gray-700">';
            if (disciplina.assuntos && Object.keys(disciplina.assuntos).length > 0) {
                for (const assuntoId in disciplina.assuntos) {
                    assuntosHTML += `
                        <li class="flex justify-between items-center">
                            <span>${disciplina.assuntos[assuntoId].nome}</span>
                            <button data-disciplina-id="${disciplina.id}" data-assunto-id="${assuntoId}" class="excluir-assunto-btn text-red-400 hover:text-red-600 font-bold text-lg leading-none">&times;</button>
                        </li>`;
                }
            } else {
                assuntosHTML += '<li class="text-gray-400 list-none">Nenhum assunto cadastrado.</li>';
            }
            assuntosHTML += '</ul>';

            disciplinaCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-lg text-blue-700">${disciplina.nome}</h3>
                    <button data-id="${disciplina.id}" class="excluir-disciplina-btn text-red-400 hover:text-red-600 font-bold text-2xl leading-none px-2 rounded-full hover:bg-red-100 transition-colors">&times;</button>
                </div>
                ${assuntosHTML}
                <div class="flex gap-2 mt-4 pt-4 border-t">
                    <input type="text" placeholder="Novo assunto" class="w-full novo-assunto-input">
                    <button data-id="${disciplina.id}" class="btn-cadastrar-assunto bg-green-500 text-white font-semibold px-4 py-1 rounded hover:bg-green-600 whitespace-nowrap">Adicionar Assunto</button>
                </div>
            `;
            container.appendChild(disciplinaCard);
        });

        container.querySelectorAll('.excluir-disciplina-btn').forEach(btn => btn.addEventListener('click', (e) => handleExcluirDisciplina(config, e.currentTarget.dataset.id)));
        container.querySelectorAll('.btn-cadastrar-assunto').forEach(btn => btn.addEventListener('click', (e) => {
            const disciplinaId = e.currentTarget.dataset.id;
            const input = e.currentTarget.previousElementSibling;
            handleCadastrarAssunto(config, disciplinaId, input);
        }));
        container.querySelectorAll('.excluir-assunto-btn').forEach(btn => btn.addEventListener('click', (e) => {
            const { disciplinaId, assuntoId } = e.currentTarget.dataset;
            handleExcluirAssunto(config, disciplinaId, assuntoId);
        }));
    }
    
    document.addEventListener('DOMContentLoaded', iniciarAplicacao);
  </script>
</body>
</html>
