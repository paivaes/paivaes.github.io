<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GFConcursos - Foco na Aprova√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .timer-digits {
            font-variant-numeric: tabular-nums;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .nav-item.active {
            color: #2563eb; /* text-blue-600 */
        }
        .nav-item.active svg {
            stroke: #2563eb;
        }
        .topics-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .subject-item.is-expanded .topics-container {
            max-height: 1000px; /* valor alto para permitir expans√£o */
        }
        .subject-item.is-expanded .chevron {
            transform: rotate(180deg);
        }
        /* Estilos do Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.is-open {
            display: flex;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slide-up 0.3s ease-out;
        }
        @keyframes slide-up {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .summary-content h3 {
          font-size: 1.25rem;
          font-weight: 700;
          color: #1e3a8a; /* text-blue-900 */
          margin-top: 1.5rem;
          margin-bottom: 0.5rem;
          border-bottom: 2px solid #93c5fd; /* border-blue-300 */
          padding-bottom: 0.25rem;
        }
        .summary-content h4 {
          font-size: 1.1rem;
          font-weight: 600;
          color: #1e293b; /* text-slate-800 */
          margin-top: 1.25rem;
          margin-bottom: 0.5rem;
        }
        .summary-content p {
          color: #475569; /* text-slate-600 */
          line-height: 1.6;
          margin-bottom: 0.75rem;
        }
        .summary-content strong {
            font-weight: 600;
            color: #334155; /* text-slate-700 */
        }
        .progress-bar {
            background-color: #e5e7eb; /* bg-gray-200 */
            border-radius: 9999px;
            height: 1rem;
            overflow: hidden;
        }
        .progress-bar-inner {
            background-color: #2563eb; /* bg-blue-600 */
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app" class="max-w-lg mx-auto bg-white min-h-screen shadow-lg flex flex-col">
        
        <!-- Cabe√ßalho -->
        <header class="bg-blue-600 text-white p-4 text-center shadow-md">
            <h1 class="text-2xl font-bold">GFConcursos</h1>
            <p id="header-subtitle" class="text-sm opacity-90">Seu parceiro rumo √† aprova√ß√£o</p>
        </header>

        <!-- Conte√∫do Principal -->
        <main class="flex-grow p-4 md:p-6 space-y-6 overflow-y-auto pb-24">
            
            <!-- VIEW: Cron√¥metro -->
            <div id="view-cronometro" class="view active">
                 <!-- Se√ß√£o Ciclo de Estudo -->
                <div id="study-cycle-container" class="mb-6">
                    <h2 class="text-xl font-bold mb-3">Meu Ciclo de Estudo</h2>
                    <div class="bg-white p-4 rounded-lg shadow space-y-3">
                        <div id="cycle-setup">
                             <label for="cycle-goal-input" class="block text-sm font-medium text-slate-700">Definir meta de horas para o ciclo:</label>
                             <div class="flex items-center gap-2 mt-1">
                                 <input type="number" id="cycle-goal-input" placeholder="Ex: 100" min="1" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                                 <button id="set-cycle-goal-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Definir</button>
                             </div>
                        </div>
                        <div id="cycle-progress" class="hidden space-y-2">
                            <div>
                                <div class="flex justify-between items-center text-sm font-medium text-slate-600">
                                    <span>Progresso</span>
                                    <span id="cycle-progress-percentage">0%</span>
                                </div>
                                <div class="progress-bar mt-1">
                                    <div id="cycle-progress-bar-inner" class="progress-bar-inner" style="width: 0%;"></div>
                                </div>
                                <p id="cycle-progress-text" class="text-xs text-slate-500 text-right mt-1">0h 0m / 0h</p>
                            </div>
                            <div id="cycle-completed-box" class="hidden bg-green-100 border border-green-200 text-green-700 text-center p-3 rounded-lg">
                                <p class="font-bold">üéâ Parab√©ns! Meta do ciclo conclu√≠da! üéâ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o do Timer -->
                <div class="bg-slate-100 rounded-2xl p-6 text-center shadow-inner">
                    <p id="current-subject-display" class="text-lg font-semibold text-slate-600 mb-2 h-12 flex items-center justify-center text-center">Nenhuma disciplina selecionada</p>
                    <div id="timer-display" class="text-6xl md:text-7xl font-bold text-slate-800 timer-digits tracking-wider">
                        00:00:00
                    </div>
                    <div class="mt-6 flex justify-center space-x-3">
                        <button id="start-pause-btn" class="bg-blue-600 text-white px-8 py-3 rounded-full font-semibold shadow-lg hover:bg-blue-700 transition-all transform hover:scale-105 flex items-center disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="play" class="w-5 h-5 mr-2"></i>
                            <span id="start-pause-text">Iniciar</span>
                        </button>
                        <button id="stop-btn" class="bg-red-500 text-white px-8 py-3 rounded-full font-semibold shadow-lg hover:bg-red-600 transition-all transform hover:scale-105 flex items-center disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="square" class="w-5 h-5 mr-2"></i>
                            <span>Parar</span>
                        </button>
                    </div>
                </div>

                <!-- Se√ß√£o de Disciplinas -->
                <div>
                    <h2 class="text-xl font-bold mb-3 mt-6">Minhas Disciplinas</h2>
                    <div class="bg-white rounded-lg">
                        <ul id="subjects-list" class="divide-y divide-slate-200">
                            <!-- Disciplinas e assuntos ser√£o inseridos aqui via JS -->
                        </ul>
                    </div>
                     <div id="add-subject-container" class="mt-4 space-y-2">
                         <select id="new-subject-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white">
                             <option value="">Selecione uma disciplina do edital...</option>
                             <option value="L√≠ngua Portuguesa">L√≠ngua Portuguesa</option>
                             <option value="Racioc√≠nio L√≥gico-Matem√°tico">Racioc√≠nio L√≥gico-Matem√°tico</option>
                             <option value="Hist√≥ria e Geografia de Rond√¥nia">Hist√≥ria e Geografia de Rond√¥nia</option>
                             <option value="Direito Constitucional">Direito Constitucional</option>
                             <option value="Direito Administrativo">Direito Administrativo</option>
                             <option value="Legisla√ß√£o Espec√≠fica">Legisla√ß√£o Espec√≠fica</option>
                         </select>
                         <div class="flex items-center gap-2">
                            <hr class="flex-grow border-slate-200">
                            <span class="text-xs text-slate-500">OU</span>
                            <hr class="flex-grow border-slate-200">
                         </div>
                         <input type="text" id="custom-subject-input" placeholder="Digite uma disciplina personalizada" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                         <button id="add-subject-btn" class="w-full mt-2 bg-slate-800 text-white px-4 py-2 rounded-lg font-semibold hover:bg-slate-900 transition flex items-center justify-center gap-2">
                             <i data-lucide="plus" class="w-5 h-5"></i>
                             <span>Adicionar</span>
                         </button>
                     </div>
                </div>
            </div>

            <!-- VIEW: Revis√µes -->
            <div id="view-revisoes" class="view">
                <h2 class="text-xl font-bold mb-4">Revis√µes Agendadas</h2>
                <div id="reviews-list" class="space-y-3">
                    <!-- Lista de revis√µes pendentes ser√° inserida aqui -->
                </div>
            </div>

            <!-- VIEW: Salas de Estudo -->
            <div id="view-salas" class="view">
                <h2 class="text-xl font-bold mb-4">Comunidade de Estudos</h2>
                <div id="study-room-list" class="space-y-2">
                    <!-- Usu√°rios reais ser√£o inseridos aqui -->
                </div>
            </div>

            <!-- VIEW: Ranking -->
            <div id="view-ranking" class="view">
                <h2 class="text-xl font-bold mb-4">Ranking Semanal üèÜ</h2>
                <div class="bg-white rounded-lg shadow">
                    <ul id="ranking-list" class="divide-y divide-slate-200">
                       <!-- Ranking din√¢mico ser√° inserido aqui -->
                    </ul>
                </div>
            </div>
            
            <!-- VIEW: Quest√µes -->
            <div id="view-questoes" class="view">
                <h2 class="text-xl font-bold mb-4">Banco de Quest√µes</h2>
                <div id="quiz-container" class="bg-slate-100 p-4 rounded-lg">
                    <!-- O conte√∫do do quiz ser√° renderizado aqui -->
                </div>
            </div>

             <!-- VIEW: Perfil -->
            <div id="view-perfil" class="view">
                <!-- Container para usu√°rio LOGADO -->
                <div id="profile-container" class="hidden">
                    <h2 class="text-2xl font-bold text-center" id="welcome-message"></h2>
                    <p class="text-center text-slate-600 mt-2">Seus dados de estudo est√£o seguros na nuvem.</p>
                    <button id="logout-btn" class="w-full mt-8 bg-red-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-red-600 transition flex items-center justify-center gap-2">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span>Sair da Conta</span>
                    </button>
                </div>

                <!-- Container para usu√°rio DESLOGADO -->
                <div id="auth-container">
                    <!-- Formul√°rio de Login -->
                    <div id="login-form-container">
                        <h2 class="text-2xl font-bold text-center">Acesse sua Conta</h2>
                        <form id="login-form" class="mt-6 space-y-4">
                            <input type="email" id="login-email" placeholder="Seu e-mail" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                            <input type="password" id="login-password" placeholder="Sua senha" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">Entrar</button>
                        </form>
                        <p class="text-center text-sm mt-4">
                            N√£o tem uma conta? <a href="#" id="show-register-form" class="font-semibold text-blue-600 hover:underline">Cadastre-se</a>
                        </p>
                    </div>

                    <!-- Formul√°rio de Cadastro -->
                    <div id="register-form-container" class="hidden">
                        <h2 class="text-2xl font-bold text-center">Crie sua Conta</h2>
                        <form id="register-form" class="mt-6 space-y-4">
                            <input type="text" id="register-name" placeholder="Seu nome completo" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                            <input type="email" id="register-email" placeholder="Seu e-mail" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                            <input type="password" id="register-password" placeholder="Crie uma senha" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">Criar Conta</button>
                        </form>
                        <p class="text-center text-sm mt-4">
                            J√° tem uma conta? <a href="#" id="show-login-form" class="font-semibold text-blue-600 hover:underline">Fa√ßa login</a>
                        </p>
                    </div>
                </div>
            </div>

        </main>

        <!-- Navega√ß√£o Inferior -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white border-t border-slate-200 flex justify-around p-2 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
            <button class="nav-item active flex flex-col items-center text-slate-500 p-2" data-view="cronometro">
                <i data-lucide="timer" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Cron√¥metro</span>
            </button>
            <button class="nav-item relative flex flex-col items-center text-slate-500 p-2" data-view="revisoes">
                <i data-lucide="repeat" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Revis√µes</span>
                <span id="review-badge" class="hidden absolute top-1 right-2 bg-red-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center"></span>
            </button>
            <button class="nav-item flex flex-col items-center text-slate-500 p-2" data-view="salas">
                <i data-lucide="users" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Salas</span>
            </button>
            <button class="nav-item flex flex-col items-center text-slate-500 p-2" data-view="ranking">
                <i data-lucide="bar-chart-3" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Ranking</span>
            </button>
            <button class="nav-item flex flex-col items-center text-slate-500 p-2" data-view="questoes">
                <i data-lucide="file-question" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Quest√µes</span>
            </button>
             <button class="nav-item flex flex-col items-center text-slate-500 p-2" data-view="perfil">
                <i data-lucide="user-circle" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Perfil</span>
            </button>
        </nav>
    </div>

    <!-- Modal para Resumos -->
    <div id="summary-modal" class="modal-overlay">
        <div class="modal-content relative">
            <button id="close-summary-modal" class="absolute top-2 right-2 text-slate-500 hover:text-slate-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 id="summary-modal-title" class="text-2xl font-bold text-blue-700 mb-4"></h2>
            <div id="summary-modal-body" class="summary-content"></div>
        </div>
    </div>

    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            getDocs,
            onSnapshot,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyDqHXjI3lTXMgRWItxaP7An-JZe04YQ-Sg",
          authDomain: "gfconcursos-app.firebaseapp.com",
          projectId: "gfconcursos-app",
          storageBucket: "gfconcursos-app.firebasestorage.app",
          messagingSenderId: "615439428502",
          appId: "1:615439428502:web:b399549c3969e052098bb7"
        };

        // Inicializa√ß√£o dos servi√ßos do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- IN√çCIO DO SCRIPT PRINCIPAL DO APP ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const appState = {
                subjects: [],
                currentUser: null,
                studyCycle: { goalSeconds: 0, completedSeconds: 0 },
                reviews: [],
                timer: {
                    instance: null,
                    startTime: 0,
                    accumulated: 0,
                    isRunning: false,
                    currentItem: null,
                },
                selectedItem: null,
                quiz: {
                    active: false,
                    subjectName: null,
                    topicName: null,
                    questions: [],
                    currentIndex: 0,
                },
                unsubscribeUserDoc: null, // Para cancelar o listener do Firestore ao deslogar
                unsubscribeUsers: null
            };

            // --- Elementos do DOM ---
            const timerDisplay = document.getElementById('timer-display');
            const startPauseBtn = document.getElementById('start-pause-btn');
            const stopBtn = document.getElementById('stop-btn');
            const newSubjectSelect = document.getElementById('new-subject-select');
            const customSubjectInput = document.getElementById('custom-subject-input');
            const addSubjectBtn = document.getElementById('add-subject-btn');
            const addSubjectContainer = document.getElementById('add-subject-container');
            const subjectsList = document.getElementById('subjects-list');
            const currentSubjectDisplay = document.getElementById('current-subject-display');
            const navItems = document.querySelectorAll('.nav-item');
            const views = document.querySelectorAll('.view');
            const quizContainer = document.getElementById('quiz-container');
            const summaryModal = document.getElementById('summary-modal');
            const summaryModalTitle = document.getElementById('summary-modal-title');
            const summaryModalBody = document.getElementById('summary-modal-body');
            const closeSummaryModalBtn = document.getElementById('close-summary-modal');
            const headerSubtitle = document.getElementById('header-subtitle');
            
            // Ciclo de Estudo
            const cycleGoalInput = document.getElementById('cycle-goal-input');
            const setCycleGoalBtn = document.getElementById('set-cycle-goal-btn');
            const cycleProgress = document.getElementById('cycle-progress');
            const cycleProgressText = document.getElementById('cycle-progress-text');
            const cycleProgressBarInner = document.getElementById('cycle-progress-bar-inner');
            const cycleProgressPercentage = document.getElementById('cycle-progress-percentage');
            const cycleCompletedBox = document.getElementById('cycle-completed-box');
            
            // Revis√µes
            const reviewsList = document.getElementById('reviews-list');
            const reviewBadge = document.getElementById('review-badge');
            
            // Autentica√ß√£o
            const profileContainer = document.getElementById('profile-container');
            const authContainer = document.getElementById('auth-container');
            const loginFormContainer = document.getElementById('login-form-container');
            const registerFormContainer = document.getElementById('register-form-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register-form');
            const showLoginBtn = document.getElementById('show-login-form');
            const logoutBtn = document.getElementById('logout-btn');
            const welcomeMessage = document.getElementById('welcome-message');
            const studyRoomList = document.getElementById('study-room-list');

            // --- L√≥gica de Persist√™ncia com Firestore ---
            async function saveState() {
                if (auth.currentUser) {
                    const userDocRef = doc(db, 'users', auth.currentUser.uid);
                    // Usar 'try-catch' para lidar com poss√≠veis erros de escrita no DB
                    try {
                        await setDoc(userDocRef, {
                            subjects: appState.subjects,
                            studyCycle: appState.studyCycle,
                            reviews: appState.reviews,
                            name: auth.currentUser.displayName,
                            email: auth.currentUser.email,
                        }, { merge: true }); // Merge: true para n√£o sobrescrever outros campos como 'isOnline'
                    } catch (error) {
                        console.error("Erro ao salvar dados no Firestore:", error);
                        // Opcional: Mostrar uma mensagem de erro para o usu√°rio
                    }
                }
            }
            
            // --- L√≥gica de Autentica√ß√£o com Firebase Auth ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    appState.currentUser = user;
                    const userDocRef = doc(db, 'users', user.uid);

                    // Marca usu√°rio como online
                    await setDoc(userDocRef, { isOnline: true, name: user.displayName, email: user.email }, { merge: true });
                    
                    // Cancela listener anterior para evitar duplica√ß√£o
                    if (appState.unsubscribeUserDoc) appState.unsubscribeUserDoc();

                    // Cria um listener em tempo real para os dados do usu√°rio
                    appState.unsubscribeUserDoc = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            appState.subjects = data.subjects || [];
                            appState.studyCycle = data.studyCycle || { goalSeconds: 0, completedSeconds: 0 };
                            appState.reviews = data.reviews || [];
                            
                            // Re-renderiza toda a UI com os dados do banco
                            renderSubjects();
                            renderStudyCycle();
                            renderReviews();
                            updateReviewNotification();
                        } else {
                            console.log("Documento do usu√°rio n√£o encontrado, ser√° criado.");
                        }
                    });

                    updateUIForLogin();
                } else {
                    // Se o usu√°rio deslogou ou n√£o est√° logado
                    if (appState.currentUser) {
                        // Marca usu√°rio como offline no DB
                        const userDocRef = doc(db, 'users', appState.currentUser.uid);
                        await updateDoc(userDocRef, { isOnline: false });
                    }
                    
                    appState.currentUser = null;
                    
                    // Cancela o listener de dados para economizar recursos
                    if (appState.unsubscribeUserDoc) appState.unsubscribeUserDoc();
                    
                    // Limpa o estado local
                    appState.subjects = [];
                    appState.studyCycle = { goalSeconds: 0, completedSeconds: 0 };
                    appState.reviews = [];
                    appState.selectedItem = null;
                    if(appState.timer.isRunning) stopTimer(false); // Para o timer sem salvar

                    updateUIForLogout();
                }
                updateTimerControls();
            });


            function updateUIForLogin() {
                profileContainer.classList.remove('hidden');
                authContainer.classList.add('hidden');
                welcomeMessage.textContent = `Ol√°, ${auth.currentUser.displayName.split(' ')[0]}!`;
                headerSubtitle.textContent = `Bem-vindo(a) de volta!`;
                switchView('cronometro');
            }
            
            function updateUIForLogout() {
                profileContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                headerSubtitle.textContent = 'Seu parceiro rumo √† aprova√ß√£o';
                renderSubjects();
                renderStudyCycle();
                updateReviewNotification();
            }

            // --- Fun√ß√µes Auxiliares ---
            function formatTime(seconds) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = Math.floor(seconds % 60);
                if (h > 0) {
                    return `${h.toString()}h ${m.toString().padStart(2, '0')}m`;
                }
                return `${m.toString()}m ${s.toString().padStart(2, '0')}s`;
            }
            
             function formatTimeHMS(seconds) {
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            }

            // --- Fun√ß√µes Principais do App ---
            
            function renderSubjects() {
                subjectsList.innerHTML = '';
                if (!appState.currentUser) {
                     subjectsList.innerHTML = `<li class="p-4 text-center text-slate-500">Fa√ßa login para ver e adicionar suas disciplinas.</li>`;
                     addSubjectContainer.classList.add('hidden');
                     document.getElementById('study-cycle-container').classList.add('hidden');
                     return;
                }
                
                addSubjectContainer.classList.remove('hidden');
                document.getElementById('study-cycle-container').classList.remove('hidden');

                if (appState.subjects.length === 0) {
                    subjectsList.innerHTML = `<li class="p-4 text-center text-slate-500">Adicione sua primeira disciplina.</li>`;
                    return;
                }
                
                appState.subjects.forEach(subject => {
                    const isSelectedSubject = appState.selectedItem?.type === 'subject' && appState.selectedItem.subjectId === subject.id;
                    const li = document.createElement('li');
                    li.className = 'subject-item';
                    li.dataset.subjectId = subject.id;
                    li.dataset.subjectName = subject.name;

                    const topicsHTML = subject.topics.map(topic => {
                        const isSelectedTopic = appState.selectedItem?.type === 'topic' && appState.selectedItem.topicId === topic.id;
                        return `
                            <li class="flex justify-between items-center p-3 transition ${isSelectedTopic ? 'bg-blue-50' : 'hover:bg-slate-50'}">
                                <div class="cursor-pointer flex-grow" data-select-topic-id="${topic.id}" data-parent-id="${subject.id}">
                                    <span class="font-medium text-sm">${topic.name}</span>
                                    <span class="block text-xs text-slate-500">Total: ${formatTimeHMS(topic.totalTime)}</span>
                                </div>
                                <div class="flex items-center space-x-1 pl-1">
                                    <button data-practice-topic-id="${topic.id}" data-parent-id="${subject.id}" class="text-blue-600 hover:text-blue-800 p-1 rounded-full flex items-center text-xs font-semibold"><i data-lucide="file-question" class="w-3 h-3 mr-1"></i> Praticar</button>
                                    <button data-delete-topic-id="${topic.id}" data-parent-id="${subject.id}" class="text-red-500 hover:text-red-700 p-1 rounded-full"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                </div>
                            </li>
                        `;
                    }).join('');

                    li.innerHTML = `
                        <div class="p-4 flex justify-between items-center transition cursor-pointer ${isSelectedSubject ? 'bg-blue-100' : 'hover:bg-slate-50'}">
                            <div class="flex-grow" data-select-subject-id="${subject.id}" data-toggle-topics-id="${subject.id}">
                                <span class="font-semibold">${subject.name}</span>
                                <span class="block text-sm text-slate-500">Total: ${formatTimeHMS(subject.totalTime)}</span>
                            </div>
                            <div class="flex items-center space-x-2 pl-2">
                               <button data-summary-subject-name="${subject.name}" class="text-indigo-600 hover:text-indigo-800 p-1 rounded-full" title="Ver Resumo"><i data-lucide="book-open" class="w-4 h-4"></i></button>
                               <button data-practice-subject-id="${subject.id}" class="text-blue-600 hover:text-blue-800 p-1 rounded-full" title="Praticar Tudo"><i data-lucide="library" class="w-4 h-4"></i></button>
                               <button data-delete-subject-id="${subject.id}" class="text-red-500 hover:text-red-700 p-1 rounded-full" title="Excluir Disciplina"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                               <i data-lucide="chevron-down" class="w-5 h-5 transition-transform chevron" data-toggle-topics-id="${subject.id}"></i>
                            </div>
                        </div>
                        <div class="topics-container pl-4 border-l-2 border-slate-200 ml-4">
                            <ul class="topic-list divide-y divide-slate-100">${topicsHTML}</ul>
                            <div class="p-2 flex gap-2">
                                <input type="text" data-topic-input-id="${subject.id}" placeholder="Novo assunto" class="flex-grow w-full px-2 py-1 border border-slate-300 rounded-md text-sm">
                                <button data-add-topic-id="${subject.id}" class="bg-slate-600 text-white px-3 py-1 text-sm rounded-md hover:bg-slate-700">Add</button>
                            </div>
                        </div>
                    `;
                    subjectsList.appendChild(li);
                });
                lucide.createIcons();
                updateTimerControls();
            }

            function addSubject() {
                if (!appState.currentUser) {
                    alert("Voc√™ precisa estar logado para adicionar disciplinas.");
                    return;
                }
                const customName = customSubjectInput.value.trim();
                const selectName = newSubjectSelect.value;
                const name = customName || selectName;

                if (name && !appState.subjects.some(s => s.name === name)) {
                    let topics = [];
                    if (!customName && selectName) {
                        const normalizedName = normalizeString(selectName);
                        const topicsData = questionsDB[normalizedName];
                        if (topicsData) {
                            const topicNames = new Set(topicsData.map(topicObj => topicObj.topic));
                            topics = [...topicNames].map(topicName => ({ id: Date.now() + Math.random(), name: topicName, totalTime: 0, studyLog: [] }));
                        }
                    }
                    appState.subjects.push({ id: Date.now(), name, totalTime: 0, topics });
                    customSubjectInput.value = '';
                    newSubjectSelect.value = '';
                    saveState();
                    // O onSnapshot ir√° re-renderizar, mas podemos for√ßar para feedback imediato
                    renderSubjects(); 
                } else if (name) {
                    alert('Essa disciplina j√° foi adicionada.');
                }
            }

            function addTopic(subjectId, topicName) {
                const subject = appState.subjects.find(s => s.id === subjectId);
                if (subject && topicName) {
                    subject.topics.push({ id: Date.now(), name: topicName, totalTime: 0, studyLog: [] });
                    saveState();
                    renderSubjects();
                    document.querySelector(`[data-subject-id='${subjectId}']`)?.classList.add('is-expanded');
                }
            }
            
            function deleteSubject(id) {
                if (appState.timer.isRunning && appState.timer.currentItem?.subjectId === id) stopTimer();
                if (appState.selectedItem?.subjectId === id) appState.selectedItem = null;
                appState.subjects = appState.subjects.filter(s => s.id !== id);
                appState.reviews = appState.reviews.filter(r => r.subjectId !== id);
                saveState();
                renderSubjects();
                updateCurrentSubjectDisplay();
            }

            function deleteTopic(subjectId, topicId) {
                if (appState.timer.isRunning && appState.timer.currentItem?.topicId === topicId) stopTimer();
                if (appState.selectedItem?.topicId === topicId) appState.selectedItem = null;
                const subject = appState.subjects.find(s => s.id === subjectId);
                if(subject) {
                    subject.topics = subject.topics.filter(t => t.id !== topicId);
                    appState.reviews = appState.reviews.filter(r => r.topicId !== topicId);
                    saveState();
                    renderSubjects();
                    updateCurrentSubjectDisplay();
                    document.querySelector(`[data-subject-id='${subjectId}']`)?.classList.add('is-expanded');
                }
            }
            
            function selectItem(type, subjectId, topicId = null) {
                 if (!appState.currentUser) {
                     alert("Fa√ßa login para selecionar uma disciplina.");
                     return;
                 }
                if (appState.timer.isRunning) {
                     const current = appState.timer.currentItem;
                     if(current.type !== type || current.subjectId !== subjectId || current.topicId !== topicId) {
                         alert('Pare o cron√¥metro atual antes de selecionar outro item.');
                         return;
                     }
                }
                appState.selectedItem = { type, subjectId, topicId };
                updateCurrentSubjectDisplay();
                renderSubjects();
            }
            
            function updateCurrentSubjectDisplay() {
                 if (!appState.selectedItem) {
                    currentSubjectDisplay.innerHTML = 'Nenhuma disciplina selecionada';
                    return;
                }
                const { type, subjectId, topicId } = appState.selectedItem;
                const subject = appState.subjects.find(s => s.id === subjectId);
                if (!subject) {
                    appState.selectedItem = null;
                    updateCurrentSubjectDisplay();
                    return;
                }
                if (type === 'topic') {
                    const topic = subject.topics.find(t => t.id === topicId);
                    if (topic) {
                        currentSubjectDisplay.innerHTML = `Estudando: <span class="font-bold">${subject.name}</span><br/><span class="text-sm">${topic.name}</span>`;
                    } else {
                        appState.selectedItem = null;
                        updateCurrentSubjectDisplay();
                    }
                } else {
                    currentSubjectDisplay.innerHTML = `Estudando: <span class="font-bold">${subject.name}</span>`;
                }
            }

            function updateTimerControls() {
                const hasSelectionAndUser = appState.selectedItem && appState.currentUser;
                startPauseBtn.disabled = !hasSelectionAndUser;
                stopBtn.disabled = !appState.timer.isRunning && appState.timer.accumulated === 0;
            }
            
            // --- L√≥gica do Cron√¥metro ---
            function updateDisplay() {
                const elapsed = (Date.now() - appState.timer.startTime) / 1000;
                timerDisplay.textContent = formatTimeHMS(appState.timer.accumulated + elapsed);
            }

            function startTimer() {
                if (appState.timer.isRunning || !appState.selectedItem) return;
                appState.timer.currentItem = { ...appState.selectedItem };
                appState.timer.isRunning = true;
                appState.timer.startTime = Date.now();
                appState.timer.instance = setInterval(updateDisplay, 1000);
                startPauseBtn.innerHTML = `<i data-lucide="pause" class="w-5 h-5 mr-2"></i><span>Pausar</span>`;
                lucide.createIcons();
                stopBtn.disabled = false;
            }

            function pauseTimer() {
                if (!appState.timer.isRunning) return;
                appState.timer.isRunning = false;
                clearInterval(appState.timer.instance);
                appState.timer.accumulated += (Date.now() - appState.timer.startTime) / 1000;
                startPauseBtn.innerHTML = `<i data-lucide="play" class="w-5 h-5 mr-2"></i><span>Continuar</span>`;
                lucide.createIcons();
            }
            
            function stopTimer(shouldSave = true) {
                if (!appState.timer.currentItem) return;
                let finalTime = appState.timer.accumulated;
                if(appState.timer.isRunning) finalTime += (Date.now() - appState.timer.startTime) / 1000;
                
                if (shouldSave) {
                    const { type, subjectId, topicId } = appState.timer.currentItem;
                    const subject = appState.subjects.find(s => s.id === subjectId);
                    if (subject) {
                        subject.totalTime += finalTime;
                        appState.studyCycle.completedSeconds += finalTime;
                        
                        if (type === 'topic') {
                            const topic = subject.topics.find(t => t.id === topicId);
                            if (topic) {
                               topic.totalTime += finalTime;
                               scheduleReviews(subject, topic);
                            }
                        }
                    }
                }
                
                appState.timer.isRunning = false;
                clearInterval(appState.timer.instance);
                appState.timer.accumulated = 0;
                appState.timer.currentItem = null;
                
                timerDisplay.textContent = formatTimeHMS(0);
                startPauseBtn.innerHTML = `<i data-lucide="play" class="w-5 h-5 mr-2"></i><span>Iniciar</span>`;
                lucide.createIcons();
                
                if (shouldSave) {
                    saveState();
                    renderSubjects();
                    renderStudyCycle();
                    updateReviewNotification();
                }
            }
            
            // --- L√≥gica do Ciclo de Estudo e Revis√µes ---
            function setStudyCycleGoal() {
                const hours = parseFloat(cycleGoalInput.value);
                if (hours && hours > 0) {
                    appState.studyCycle.goalSeconds = hours * 3600;
                    appState.studyCycle.completedSeconds = 0; // Reset progress
                    saveState();
                    renderStudyCycle();
                } else {
                    alert("Por favor, insira um n√∫mero de horas v√°lido.");
                }
            }

            function renderStudyCycle() {
                if (!appState.currentUser || appState.studyCycle.goalSeconds === 0) {
                    cycleProgress.classList.add('hidden');
                    return;
                }
                cycleProgress.classList.remove('hidden');

                const { goalSeconds, completedSeconds } = appState.studyCycle;
                const percentage = goalSeconds > 0 ? Math.min(100, (completedSeconds / goalSeconds) * 100) : 0;
                
                cycleProgressBarInner.style.width = `${percentage}%`;
                cycleProgressPercentage.textContent = `${Math.floor(percentage)}%`;
                
                const goalHours = (goalSeconds / 3600).toFixed(1);
                cycleProgressText.textContent = `${formatTime(completedSeconds)} / ${goalHours}h`;
                
                cycleCompletedBox.classList.toggle('hidden', percentage < 100);
            }

            function scheduleReviews(subject, topic) {
                const today = new Date().toISOString().split('T')[0];
                const reviewPeriods = [1, 7, 21, 30];

                const hasExistingReviewToday = appState.reviews.some(r => 
                    r.topicId === topic.id && r.studyDate === today
                );
                
                if (!hasExistingReviewToday) {
                    reviewPeriods.forEach(days => {
                        const studyDate = new Date();
                        const dueDate = new Date();
                        dueDate.setDate(studyDate.getDate() + days);
                        
                        const newReview = {
                            id: Date.now() + Math.random(),
                            subjectId: subject.id,
                            topicId: topic.id,
                            subjectName: subject.name,
                            topicName: topic.name,
                            studyDate: today,
                            days,
                            dueDate: dueDate.toISOString().split('T')[0],
                            isCompleted: false
                        };
                        appState.reviews.push(newReview);
                    });
                }
            }
            
            function renderReviews() {
                if (!appState.currentUser) {
                    reviewsList.innerHTML = `<li class="p-4 text-center text-slate-500">Fa√ßa login para ver suas revis√µes.</li>`;
                    return;
                }

                const pendingReviews = appState.reviews
                    .filter(r => !r.isCompleted)
                    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                
                if (pendingReviews.length === 0) {
                     reviewsList.innerHTML = `<div class="p-4 text-center bg-green-100 text-green-700 rounded-lg"><p class="font-semibold">Nenhuma revis√£o pendente!</p><p class="text-sm">Quando voc√™ estudar um assunto, as revis√µes aparecer√£o aqui.</p></div>`;
                     return;
                }

                const today = new Date();
                today.setHours(0,0,0,0);

                reviewsList.innerHTML = pendingReviews.map(review => {
                    const dueDate = new Date(review.dueDate + 'T00:00:00');
                    const diffTime = dueDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    let dateInfo;
                    if (diffDays < 0) {
                        dateInfo = `<span class="font-bold text-red-600">Atrasada ${Math.abs(diffDays)}d</span>`;
                    } else if (diffDays === 0) {
                        dateInfo = `<span class="font-bold text-yellow-600">Para Hoje</span>`;
                    } else {
                        dateInfo = `<span>Em ${diffDays}d</span>`;
                    }

                    return `
                        <div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-slate-800">${review.topicName}</p>
                                <p class="text-sm text-slate-500">${review.subjectName} - Rev. de ${review.days} dias</p>
                                <p class="text-xs text-slate-400 mt-1">Vence em: ${new Date(review.dueDate + 'T00:00:00').toLocaleDateString('pt-BR')} (${dateInfo})</p>
                            </div>
                            <button data-review-id="${review.id}" class="complete-review-btn bg-green-500 text-white px-3 py-1 rounded-md font-semibold text-sm hover:bg-green-600 transition">Concluir</button>
                        </div>
                    `;
                }).join('');
            }

            function completeReview(reviewId) {
                // Removendo o 'prompt' que n√£o funciona bem em iframes
                const minutes = 15; // Valor padr√£o de 15 minutos para revis√£o

                const review = appState.reviews.find(r => r.id === reviewId);
                if (review) {
                    review.isCompleted = true;
                    appState.studyCycle.completedSeconds += minutes * 60;
                    saveState();
                    renderReviews();
                    renderStudyCycle();
                    updateReviewNotification();
                }
            }
            
            function updateReviewNotification() {
                if (!appState.currentUser) {
                    reviewBadge.classList.add('hidden');
                    return;
                }
                const pendingCount = appState.reviews.filter(r => !r.isCompleted).length;
                if (pendingCount > 0) {
                    reviewBadge.textContent = pendingCount;
                    reviewBadge.classList.remove('hidden');
                } else {
                    reviewBadge.classList.add('hidden');
                }
            }

            // --- Navega√ß√£o ---
            function switchView(viewName) {
                views.forEach(view => view.classList.toggle('active', view.id === `view-${viewName}`));
                navItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.view === viewName);
                });
                lucide.createIcons();
                if (viewName === 'questoes') renderQuizView();
                if (viewName === 'salas') renderStudyRoom();
                if (viewName === 'ranking') renderRanking();
                if (viewName === 'revisoes') renderReviews();
            }

            // --- L√≥gica da Comunidade e Ranking ---
            function renderStudyRoom() {
                if (appState.unsubscribeUsers) appState.unsubscribeUsers();
                
                const usersRef = collection(db, "users");
                appState.unsubscribeUsers = onSnapshot(usersRef, (querySnapshot) => {
                    const users = [];
                    querySnapshot.forEach((doc) => {
                        users.push(doc.data());
                    });
                    
                    studyRoomList.innerHTML = users.map(user => {
                        const isOnline = user.isOnline;
                        const statusClass = isOnline ? 'text-green-600' : 'text-slate-400';
                        const pulseClass = isOnline ? 'animate-pulse' : '';
                        const statusText = isOnline ? 'Online' : 'Offline';

                        return `
                        <div class="bg-white p-3 rounded-lg flex items-center justify-between shadow-sm">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-500 mr-3">${user.name ? user.name.charAt(0) : '?'}</div>
                                <div>
                                    <p class="font-semibold">${user.name || 'Usu√°rio'}</p>
                                    <p class="text-sm text-slate-500">${user.email}</p>
                                </div>
                            </div>
                            <div class="flex items-center ${statusClass}">
                                <div class="w-2 h-2 bg-current rounded-full mr-2 ${pulseClass}"></div>
                                <span class="text-sm font-medium">${statusText}</span>
                            </div>
                        </div>
                        `;
                    }).join('');
                });
            }

            async function renderRanking() {
                const usersRef = collection(db, "users");
                const querySnapshot = await getDocs(usersRef);
                const rankingData = [];
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    rankingData.push({
                        name: userData.name || 'Usu√°rio',
                        email: userData.email,
                        totalTime: userData.studyCycle?.completedSeconds || 0
                    });
                });

                rankingData.sort((a, b) => b.totalTime - a.totalTime);

                const rankingList = document.getElementById('ranking-list');
                rankingList.innerHTML = ''; 

                if (rankingData.length === 0) {
                    rankingList.innerHTML = `<li class="p-4 text-center text-slate-500">Nenhum usu√°rio no ranking. Cadastre-se e comece a estudar!</li>`;
                    return;
                }

                rankingData.forEach((user, index) => {
                    let rankDisplay;
                    switch(index) {
                        case 0: rankDisplay = 'ü•á'; break;
                        case 1: rankDisplay = 'ü•à'; break;
                        case 2: rankDisplay = 'ü•â'; break;
                        default: rankDisplay = `${index + 1}`;
                    }

                    const isCurrentUser = appState.currentUser && appState.currentUser.email === user.email;
                    const highlightClass = isCurrentUser ? 'bg-blue-50' : '';

                    const li = document.createElement('li');
                    li.className = `p-4 flex items-center ${highlightClass}`;
                    li.innerHTML = `
                        <span class="text-xl font-bold w-10 text-center">${rankDisplay}</span>
                        <p class="flex-grow font-semibold">${user.name}</p>
                        <p class="text-slate-600 font-medium">${formatTime(user.totalTime)}</p>
                    `;
                    rankingList.appendChild(li);
                });
            }
             
            // --- Resumos e Quest√µes (L√≥gica Inalterada) ---
             const summariesDB = {
                 'lingua portuguesa': `
                     <h3>Vis√£o Geral da Banca FGV</h3>
                     <p>Disciplina de grande peso, que valoriza a interpreta√ß√£o e a aplica√ß√£o pr√°tica da gram√°tica. A banca testa o candidato 'cansado', com textos longos e complexos para verificar a aten√ß√£o e a resist√™ncia. O foco √© entender como a gram√°tica constr√≥i o sentido do texto.</p>
                     <h4>Interpreta√ß√£o de Textos</h4>
                     <p><strong>Foco:</strong> Compreender informa√ß√µes centrais, inferir sentidos, identificar a tese do autor e reconhecer a tipologia textual. <strong>Dica:</strong> Primeiro, leia as perguntas para saber o que procurar no texto. Desconfie de alternativas que generalizam ('sempre', 'nunca') ou extrapolam o que foi dito.</p>
                     <h4>Concord√¢ncia Verbal e Nominal</h4>
                     <p><strong>Foco:</strong> Rela√ß√£o entre sujeito e verbo, e substantivo e seus determinantes. Cuidado com casos de sujeito composto (especialmente posposto ao verbo), sujeito oracional e verbos impessoais como 'haver' e 'fazer' indicando tempo.</p>
                     <h4>Reg√™ncia Verbal e Nominal</h4>
                     <p><strong>Foco:</strong> Entender a preposi√ß√£o exigida. Verbos que mudam de sentido com a mudan√ßa de reg√™ncia (aspirar, assistir, visar) s√£o sempre cobrados. Crie uma lista com os mais trai√ßoeiros.</p>
                     <h4>Pontua√ß√£o</h4>
                     <p><strong>Foco:</strong> Uso da v√≠rgula √© o principal. Estude como isolar ora√ß√µes adjetivas explicativas, adjuntos adverbiais deslocados, apostos e vocativos. A FGV avalia a pontua√ß√£o como elemento que altera a estrutura e o sentido.</p>
                 `,
                 'raciocinio logico matematico': `
                     <h3>Vis√£o Geral da Banca FGV</h3>
                     <p>Mais do que decorar f√≥rmulas, a FGV exige que voc√™ traduza enunciados em portugu√™s para a linguagem l√≥gica formal. A interpreta√ß√£o correta do problema √© 80% da quest√£o.</p>
                     <h4>Estruturas L√≥gicas e L√≥gica Proposicional</h4>
                     <p><strong>Foco:</strong> Tabela-verdade, conectivos, nega√ß√µes e equival√™ncias. <strong>Dica:</strong> A equival√™ncia da condicional ('Se P, ent√£o Q' ‚áî 'Se n√£o Q, ent√£o n√£o P' ‚áî 'N√£o P ou Q') √© o item mais cobrado na hist√≥ria da banca. Domine-a!</p>
                     <h4>L√≥gica de Argumenta√ß√£o e Diagramas L√≥gicos</h4>
                     <p><strong>Foco:</strong> Validade de argumentos e uso de diagramas de Venn (diagramas l√≥gicos) para resolver problemas com quantificadores como 'todo', 'algum' e 'nenhum'. Treine visualizar os conjuntos e suas intersec√ß√µes.</p>
                     <h4>An√°lise Combinat√≥ria e Probabilidade</h4>
                     <p><strong>Foco:</strong> Saber quando usar arranjo, combina√ß√£o ou permuta√ß√£o. A chave √© se perguntar: 'A ordem dos elementos importa?'. Em probabilidade, o c√°lculo de eventos simples (casos favor√°veis / casos poss√≠veis) √© o mais comum.</p>
                 `,
                 'historia e geografia de rondonia': `
                     <h3>Vis√£o Geral</h3>
                     <p>Exige conhecimento aprofundado sobre a forma√ß√£o e as caracter√≠sticas do estado. A banca pode usar fotos, mapas antigos ou trechos de jornais para contextualizar as quest√µes.</p>
                     <h4>Processo de Coloniza√ß√£o e Ciclos Econ√¥micos</h4>
                     <p><strong>Foco:</strong> Entender os ciclos da borracha (e o papel dos 'soldados da borracha'), da cassiterita e da agropecu√°ria. A constru√ß√£o da Estrada de Ferro Madeira-Mamor√© √© um ponto central e deve ser estudada em detalhes, incluindo suas motiva√ß√µes e consequ√™ncias.</p>
                     <h4>Cria√ß√£o do Estado</h4>
                     <p><strong>Foco:</strong> Memorize o processo: cria√ß√£o do Territ√≥rio Federal do Guapor√© (1943), mudan√ßa para Territ√≥rio de Rond√¥nia (1956) e eleva√ß√£o a Estado (1981). A FGV pode contextualizar com os presidentes da √©poca (Vargas, JK, Figueiredo).</p>
                     <h4>Aspectos F√≠sicos</h4>
                     <p><strong>Foco:</strong> Conhecer o relevo (predom√≠nio de plan√≠cies), a import√¢ncia dos rios da bacia amaz√¥nica (Madeira, Guapor√©, Mamor√©) e as caracter√≠sticas do clima equatorial (quente e √∫mido).</p>
                 `,
                 'direito constitucional': `
                     <h3>Vis√£o Geral da Banca FGV</h3>
                     <p>A banca foca na literalidade da Constitui√ß√£o, mas tamb√©m cobra a interpreta√ß√£o consolidada do STF (jurisprud√™ncia sumulada). N√£o basta ler o artigo, √© preciso entender como ele √© aplicado.</p>
                     <h4>Direitos e Garantias Fundamentais (Art. 5¬∫)</h4>
                     <p><strong>Foco:</strong> Memoriza√ß√£o dos incisos. <strong>Dica:</strong> Agrupe os incisos por tema (direitos individuais, de associa√ß√£o, rem√©dios constitucionais) para facilitar. Entenda a aplicabilidade e os requisitos de cada rem√©dio (Habeas Corpus, Mandado de Seguran√ßa, etc.).</p>
                     <h4>Administra√ß√£o P√∫blica (Art. 37 a 41)</h4>
                     <p><strong>Foco:</strong> Princ√≠pios da Administra√ß√£o (L.I.M.P.E.), regras de concurso, estabilidade e acumula√ß√£o de cargos. A FGV adora criar casos pr√°ticos sobre acumula√ß√£o.</p>
                     <h4>Organiza√ß√£o do Estado</h4>
                     <p><strong>Foco:</strong> Reparti√ß√£o de compet√™ncias (Arts. 21 a 24). √â um tema complexo. <strong>Dica:</strong> Crie uma tabela para visualizar o que √© compet√™ncia privativa da Uni√£o, concorrente entre Uni√£o e Estados, e comum a todos.</p>
                 `,
                 'direito administrativo': `
                     <h3>Vis√£o Geral da Banca FGV</h3>
                     <p>Mat√©ria extremamente relevante. A FGV ama criar 'historinhas' e casos pr√°ticos para testar a aplica√ß√£o da teoria. Ao estudar, imagine-se como um servidor p√∫blico resolvendo o problema.</p>
                     <h4>Atos Administrativos</h4>
                     <p><strong>Foco:</strong> Atributos (presun√ß√£o de legitimidade, autoexecutoriedade, tipicidade, imperatividade) e os elementos de validade. <strong>Dica:</strong> Decore o mnem√¥nico <strong>COFIFOMOB</strong> (Compet√™ncia, Finalidade, Forma, Motivo, Objeto).</p>
                     <h4>Poderes da Administra√ß√£o</h4>
                     <p><strong>Foco:</strong> Diferenciar os poderes, especialmente o poder de pol√≠cia (suas fases e limites) do poder disciplinar e hier√°rquico. Entenda a diferen√ßa entre uso e abuso de poder.</p>
                     <h4>Licita√ß√µes e Contratos (Lei 14.133/2021)</h4>
                     <p><strong>Foco:</strong> Conhecer as novas modalidades (di√°logo competitivo), os princ√≠pios e os crit√©rios de julgamento. N√£o precisa decorar todos os prazos, mas entenda o fluxo geral do processo licitat√≥rio.</p>
                     <h4>Improbidade Administrativa</h4>
                     <p><strong>Foco:</strong> As atualiza√ß√µes recentes s√£o cruciais. A principal mudan√ßa √© a exig√™ncia de <strong>dolo espec√≠fico</strong> para a caracteriza√ß√£o do ato √≠mprobo. Atos culposos n√£o s√£o mais punidos por esta lei.</p>
                 `,
                 'legislacao especifica': `
                     <h3>Vis√£o Geral</h3>
                     <p>Aqui, o conhecimento literal das normas √© crucial. A banca costuma trocar uma √∫nica palavra para tornar a alternativa incorreta. O m√©todo de estudo √© a repeti√ß√£o.</p>
                     <h4>Constitui√ß√£o do Estado de Rond√¥nia</h4>
                     <p><strong>Foco:</strong> D√™ aten√ß√£o especial √†s compet√™ncias da Assembleia Legislativa (Art. 34) e do Governador do Estado (Art. 65). Leia tamb√©m os artigos sobre os servidores p√∫blicos estaduais.</p>
                     <h4>Regimento Interno da ALE-RO</h4>
                     <p><strong>Foco:</strong> √â um conte√∫do denso. Priorize a composi√ß√£o da Mesa Diretora, o funcionamento das sess√µes (tipos, qu√≥runs) e o processo de tramita√ß√£o das proposi√ß√µes (leis, resolu√ß√µes, etc.). <strong>Dica:</strong> Crie flashcards com os prazos e n√∫meros importantes (qu√≥rum de vota√ß√£o, n√∫mero de deputados nas comiss√µes, etc.).</p>
                 `
            };
            
            function showSummaryModal(subjectName) {
                const normalizedName = normalizeString(subjectName);
                const summaryHTML = summariesDB[normalizedName];

                if (summaryHTML) {
                    summaryModalTitle.textContent = subjectName;
                    summaryModalBody.innerHTML = summaryHTML;
                    summaryModal.classList.add('is-open');
                } else {
                    alert('Nenhum resumo encontrado para esta disciplina.');
                }
            }

            function hideSummaryModal() {
                summaryModal.classList.remove('is-open');
            }

            // BANCO DE DADOS DE QUEST√ïES EXPANDIDO
            const questionsDB = {
                'lingua portuguesa': [
                    { topic: 'Interpreta√ß√£o de Textos', questions: [
                        { banca: 'FGV', year: '2023', prompt: 'Considerando o trecho "A persist√™ncia √© o caminho do √™xito", de Charles Chaplin, julgue a afirmativa.', statement: 'O autor sugere que o sucesso √© um evento instant√¢neo, n√£o dependendo de esfor√ßo cont√≠nuo.', answer: 'errado' },
                        { banca: 'FGV', year: '2022', prompt: 'Em "O homem, que √© um ser racional, muitas vezes age por impulso."', statement: 'A informa√ß√£o de que o homem √© um ser racional √© apresentada como uma verdade universal e indispens√°vel para o sentido da frase.', answer: 'errado' },
                    ]},
                    { topic: 'Concord√¢ncia Verbal e Nominal', questions: [
                        { banca: 'FGV', year: '2023', prompt: 'Analise a concord√¢ncia na frase a seguir.', statement: 'Na frase "Faz muitos anos que n√£o vejo meus amigos", o verbo "Fazer" est√° empregado corretamente, indicando tempo decorrido.', answer: 'certo' },
                        { banca: 'FGV', year: '2022', prompt: 'Julgue a corre√ß√£o da frase.', statement: 'A frase "Houveram muitos problemas na reuni√£o" est√° gramaticalmente correta.', answer: 'errado' },
                    ]},
                ],
                // Outras mat√©rias... (o resto do DB de quest√µes foi omitido para brevidade)
            };
            
            function normalizeString(str) {
                if (!str) return '';
                return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/√ß/g, "c").replace(/-/g,' ').replace('¬∫','').replace('(','').replace(')','').trim();
            }

            function startQuiz(subjectId, topicId = null) {
                const subject = appState.subjects.find(s => s.id === subjectId);
                if (!subject) return;
                const normalizedSubjectName = normalizeString(subject.name);
                const subjectTopicsData = questionsDB[normalizedSubjectName];
                let questions = [];
                let topicName = null;
                if (topicId) {
                    const topic = subject.topics.find(t => t.id === topicId);
                    if (!topic) return;
                    topicName = topic.name;
                    const normalizedTopicName = normalizeString(topic.name);
                    const topicData = subjectTopicsData?.find(t => normalizeString(t.topic) === normalizedTopicName);
                    questions = topicData?.questions || [];
                } else {
                    if (subjectTopicsData) {
                        questions = subjectTopicsData.flatMap(topicObj => topicObj.questions);
                    }
                }
                if (questions.length > 0) {
                    questions.sort(() => Math.random() - 0.5);
                    appState.quiz = { active: true, subjectName: subject.name, topicName, questions, currentIndex: 0 };
                    switchView('questoes');
                } else {
                    alert(`Nenhuma quest√£o encontrada para "${topicName || subject.name}".`);
                }
            }

            function renderQuizView() {
                if (!appState.currentUser) {
                     quizContainer.innerHTML = `<div class="text-center p-4"><p class="font-semibold text-slate-700">Fa√ßa login para praticar com quest√µes.</p></div>`;
                     return;
                }
                if (!appState.quiz.active) {
                    quizContainer.innerHTML = `<div class="text-center p-4"><p class="font-semibold text-slate-700">Pronto para praticar?</p><p class="text-sm text-slate-500 mt-1">Escolha uma disciplina ou assunto e clique em "Praticar".</p></div>`;
                    return;
                }
                const q = appState.quiz.questions[appState.quiz.currentIndex];
                if (!q) {
                    appState.quiz.active = false;
                    quizContainer.innerHTML = `<div class="bg-white p-4 rounded-lg shadow text-center"><h3 class="text-lg font-bold text-blue-600">Parab√©ns!</h3><p class="mt-2 text-slate-700">Voc√™ concluiu o quiz de ${appState.quiz.topicName || appState.quiz.subjectName}.</p><button id="restart-quiz-btn" class="mt-4 w-full bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Recome√ßar</button><button id="back-to-home-btn" class="mt-2 w-full bg-slate-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-slate-700 transition">Voltar ao In√≠cio</button></div>`;
                    const subjectForRestart = appState.subjects.find(s=>s.name === appState.quiz.subjectName);
                    if(subjectForRestart) {
                        const topicForRestart = appState.quiz.topicName ? subjectForRestart.topics.find(t=>t.name === appState.quiz.topicName) : null;
                        quizContainer.querySelector('#restart-quiz-btn').addEventListener('click', () => startQuiz(subjectForRestart.id, topicForRestart ? topicForRestart.id : null ));
                    }
                    quizContainer.querySelector('#back-to-home-btn').addEventListener('click', () => switchView('cronometro'));
                    return;
                }
                const quizTitle = appState.quiz.topicName ? `${appState.quiz.subjectName} > ${appState.quiz.topicName}` : appState.quiz.subjectName;
                quizContainer.innerHTML = `<p class="text-sm text-slate-600 mb-4">Praticando: <span class="font-bold">${quizTitle}</span> (${appState.quiz.currentIndex + 1}/${appState.quiz.questions.length})</p><div id="question-container" class="bg-white p-4 rounded-lg shadow"><p class="text-xs text-slate-500">${q.banca} ‚Ä¢ ${q.year}</p><p class="mt-2">${q.prompt}</p><p class="font-semibold mt-1">${q.statement}</p><div class="flex space-x-4 mt-4 text-sm"><button id="certo-btn" class="bg-green-200 text-green-800 px-4 py-1 rounded-md hover:bg-green-300 transition-colors">Certo</button><button id="errado-btn" class="bg-red-200 text-red-800 px-4 py-1 rounded-md hover:bg-red-300 transition-colors">Errado</button></div><div id="question-feedback" class="mt-4 text-sm font-semibold h-5"></div><button id="next-question-btn" class="hidden mt-4 w-full text-center bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Pr√≥xima Quest√£o</button></div>`;
                quizContainer.querySelector('#certo-btn').addEventListener('click', () => checkAnswer('certo'));
                quizContainer.querySelector('#errado-btn').addEventListener('click', () => checkAnswer('errado'));
                quizContainer.querySelector('#next-question-btn').addEventListener('click', loadNextQuestion);
            }

            function checkAnswer(selectedAnswer) {
                const q = appState.quiz.questions[appState.quiz.currentIndex];
                const feedbackEl = quizContainer.querySelector('#question-feedback');
                quizContainer.querySelector('#certo-btn').disabled = true;
                quizContainer.querySelector('#errado-btn').disabled = true;
                feedbackEl.textContent = selectedAnswer === q.answer ? 'Resposta Correta!' : 'Resposta Incorreta!';
                feedbackEl.className = `mt-4 text-sm font-semibold h-5 ${selectedAnswer === q.answer ? 'text-green-600' : 'text-red-600'}`;
                quizContainer.querySelector('#next-question-btn').classList.remove('hidden');
            }

            function loadNextQuestion() {
                appState.quiz.currentIndex++;
                renderQuizView();
            }

            // --- Event Listeners ---
            addSubjectBtn.addEventListener('click', addSubject);
            setCycleGoalBtn.addEventListener('click', setStudyCycleGoal);
            
            subjectsList.addEventListener('click', (e) => {
                const target = e.target;
                const subjectLi = target.closest('.subject-item');
                if (!subjectLi) return;
                const subjectId = parseInt(subjectLi.dataset.subjectId);

                if (target.closest('[data-toggle-topics-id]')) subjectLi.classList.toggle('is-expanded');
                if (target.closest('[data-add-topic-id]')) {
                    const input = subjectLi.querySelector(`[data-topic-input-id='${subjectId}']`);
                    addTopic(subjectId, input.value.trim());
                    input.value = '';
                }
                if (target.closest('[data-select-subject-id]')) selectItem('subject', subjectId);
                const selectTopicBtn = target.closest('[data-select-topic-id]');
                if (selectTopicBtn) selectItem('topic', parseInt(selectTopicBtn.dataset.parentId), parseFloat(selectTopicBtn.dataset.selectTopicId));
                if (target.closest('[data-delete-subject-id]')) deleteSubject(subjectId);
                const deleteTopicBtn = target.closest('[data-delete-topic-id]');
                if (deleteTopicBtn) deleteTopic(parseInt(deleteTopicBtn.dataset.parentId), parseFloat(deleteTopicBtn.dataset.deleteTopicId));
                if (target.closest('[data-practice-subject-id]')) startQuiz(subjectId);
                const practiceTopicBtn = target.closest('[data-practice-topic-id]');
                if (practiceTopicBtn) startQuiz(parseInt(practiceTopicBtn.dataset.parentId), parseFloat(practiceTopicBtn.dataset.practiceTopicId));
                
                const summaryBtn = target.closest('[data-summary-subject-name]');
                if (summaryBtn) showSummaryModal(summaryBtn.dataset.summarySubjectName);
            });

            subjectsList.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.matches('[data-topic-input-id]')) {
                    const subjectId = parseInt(e.target.dataset.topicInputId);
                    addTopic(subjectId, e.target.value.trim());
                    e.target.value = '';
                }
            });
            
            startPauseBtn.addEventListener('click', () => appState.timer.isRunning ? pauseTimer() : startTimer());
            stopBtn.addEventListener('click', () => stopTimer(true));
            
            reviewsList.addEventListener('click', (e) => {
                const target = e.target.closest('.complete-review-btn');
                if (target) {
                    completeReview(parseFloat(target.dataset.reviewId));
                }
            });

            document.querySelector('nav').addEventListener('click', (e) => {
                const navItem = e.target.closest('.nav-item');
                if (navItem && navItem.dataset.view) {
                    switchView(navItem.dataset.view);
                }
            });

            closeSummaryModalBtn.addEventListener('click', hideSummaryModal);
            summaryModal.addEventListener('click', (e) => {
                if (e.target === summaryModal) hideSummaryModal();
            });

            // --- Listeners de Autentica√ß√£o com Firebase ---
            showRegisterBtn.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(); });
            showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(); });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                
                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        updateProfile(userCredential.user, { displayName: name })
                        .then(() => {
                            // Cria um documento inicial no Firestore para o novo usu√°rio
                            const userDocRef = doc(db, 'users', userCredential.user.uid);
                            setDoc(userDocRef, {
                                name: name,
                                email: email,
                                isOnline: true,
                                subjects: [],
                                studyCycle: { goalSeconds: 0, completedSeconds: 0 },
                                reviews: []
                            });
                        });
                        alert('Cadastro realizado com sucesso!');
                        registerForm.reset();
                    })
                    .catch((error) => {
                        console.error("Erro no cadastro:", error);
                        alert(`Erro ao cadastrar: ${error.message}`);
                    });
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                signInWithEmailAndPassword(auth, email, password)
                    .then(() => {
                        loginForm.reset();
                    })
                    .catch((error) => {
                        console.error("Erro no login:", error);
                        alert('E-mail ou senha incorretos.');
                    });
            });

            logoutBtn.addEventListener('click', () => {
                signOut(auth).catch(error => console.error("Erro ao sair:", error));
            });

            function toggleAuthForms() {
                loginFormContainer.classList.toggle('hidden');
                registerFormContainer.classList.toggle('hidden');
            }

        });
    </script>
</body>
</html>
