<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Plataforma de Estudos GFConcursos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
    .container { max-width: 1200px; margin: auto; padding: 20px; }
    .card { background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
    h2 { font-size: 1.5rem; font-weight: 700; color: #1e3a8a; margin-bottom: 1rem; border-bottom: 2px solid #93c5fd; padding-bottom: 0.5rem;}
    select, input, button, textarea {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        border: 1px solid #d1d5db;
        transition: all 0.2s;
        font-size: 1rem;
    }
    textarea { width: 100%; min-height: 250px; }
    button { cursor: pointer; }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .tab-button { background-color: #e5e7eb; }
    .tab-button.active { background-color: #3b82f6; color: white; }
    .option-button { display: block; width: 100%; text-align: left; background-color: #f3f4f6; margin-bottom: 0.5rem; }
    .option-button:hover { background-color: #e5e7eb; }
    .option-button.correct { background-color: #d1fae5; border-color: #10b981; }
    .option-button.incorrect { background-color: #fee2e2; border-color: #ef4444; }
    .priority-item { cursor: grab; user-select: none; }
    .priority-item:active { cursor: grabbing; background-color: #f0f4ff; }
    .dragging { opacity: 0.5; }
  </style>
</head>
<body>

  <div class="container">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-bold text-blue-800">Plataforma de Estudos GFConcursos</h1>
      <p id="auth-status" class="text-slate-600">Carregando...</p>
    </header>

    <!-- Autentica√ß√£o -->
    <div id="auth-container" class="card max-w-md mx-auto">
        <div id="login-view">
            <h2 class="text-xl font-bold">Acessar Conta</h2>
            <input type="email" id="login-email" placeholder="E-mail" class="w-full mb-2 p-2">
            <input type="password" id="login-password" placeholder="Senha" class="w-full mb-2 p-2">
            <button id="btn-login" class="w-full bg-blue-600 text-white font-semibold py-2">Entrar</button>
        </div>
         <div id="logout-view" class="hidden text-center">
            <p id="welcome-message" class="mb-4 text-lg"></p>
            <button id="btn-logout" class="w-full bg-red-500 text-white font-semibold py-2">Sair</button>
        </div>
    </div>
    
    <!-- Abas de Navega√ß√£o -->
    <div id="tabs-container" class="mb-6 hidden">
        <div class="md:hidden text-right mb-4">
            <button id="menu-toggle" class="p-2 rounded bg-gray-200">Menu</button>
        </div>
        <nav id="nav-menu" class="hidden md:flex flex-col md:flex-row md:space-x-2 space-y-2 md:space-y-0">
            <button class="tab-button px-4 py-2 rounded" data-tab="estudo">Estudo</button>
            <button class="tab-button px-4 py-2 rounded" data-tab="simulados">Simulados</button>
            <button class="tab-button px-4 py-2 rounded" data-tab="redacao">Reda√ß√£o</button>
            <button class="tab-button px-4 py-2 rounded" data-tab="progresso">Progresso</button>
            <button class="tab-button px-4 py-2 rounded" data-tab="edital">Edital</button>
            <button class="tab-button px-4 py-2 rounded" data-tab="perfil">Meu Perfil</button>
            <button class="tab-button px-4 py-2 rounded" data-tab="ranking">Ranking</button>
            <button class="tab-button px-4 py-2 rounded" data-tab="desafios">Desafios</button>
        </nav>
    </div>

    <!-- Conte√∫do principal do App (inicialmente oculto) -->
    <div id="main-content" class="hidden">
      
      <!-- Aba de Estudo -->
      <div id="tab-content-estudo" class="tab-content">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Coluna da Esquerda: Sele√ß√£o e Pr√°tica -->
            <div>
              <div class="card">
                <h2>Menu de Disciplinas</h2>
                <label for="seletorDisciplina" class="block mb-2 font-semibold">1. Escolha a disciplina:</label>
                <select id="seletorDisciplina" class="w-full"></select>
                <div id="listaAssuntos" class="mt-4 space-y-3"></div>
              </div>
    
              <div class="card">
                  <h2>Praticar Quest√µes</h2>
                   <div class="grid grid-cols-2 gap-4">
                      <div>
                          <label for="nivelDificuldade" class="block mb-1 font-semibold">Dificuldade:</label>
                          <select id="nivelDificuldade" class="w-full">
                            <option value="">Todas</option>
                            <option value="facil">F√°cil</option>
                            <option value="medio">M√©dio</option>
                            <option value="dificil">Dif√≠cil</option>
                          </select>
                      </div>
                      <div>
                          <label for="quantidadeQuestoes" class="block mb-1 font-semibold">Quantidade:</label>
                          <input type="number" id="quantidadeQuestoes" value="10" min="1" max="100" class="w-full">
                      </div>
                   </div>
                   <button id="btn-iniciar-pratica" class="w-full bg-orange-500 text-white font-semibold mt-4 py-2 hover:bg-orange-600">Praticar Disciplina Selecionada</button>
              </div>
    
              <div class="card">
                  <h2>Revis√£o Inteligente üß†</h2>
                  <label for="quantidadeQuestoesInteligente" class="block mb-1 font-semibold">Quantidade de Quest√µes:</label>
                  <input type="number" id="quantidadeQuestoesInteligente" value="20" min="5" max="100" class="w-full mb-2">
                  <button id="btn-revisao-inteligente" class="w-full bg-indigo-600 text-white font-semibold">Iniciar Revis√£o Inteligente</button>
              </div>
    
            </div>
    
            <!-- Coluna da Direita: Dashboards -->
            <div>
              <div class="card">
                <h2>Metas e Prioridades do Ciclo</h2>
                <div class="mb-4">
                    <label for="ciclo-nome-input" class="block font-semibold mb-1">Nome do Ciclo:</label>
                    <input type="text" id="ciclo-nome-input" placeholder="Ex: Rumo √† Aprova√ß√£o (ALE-RO)" class="w-full">
                </div>
                <div class="mb-4 border-t pt-4 mt-4">
                    <label for="meta-geral-horas" class="block font-semibold mb-1">Meta Geral de Horas do Ciclo:</label>
                    <input type="number" id="meta-geral-horas" placeholder="Ex: 100" class="w-full">
                </div>
                <div>
                    <label class="block font-semibold mb-1">Prioridade das Disciplinas:</label>
                    <p class="text-sm text-slate-500 mb-2">Arraste para reordenar (a de cima √© a mais importante).</p>
                    <div id="lista-prioridades" class="border rounded p-2 space-y-2">
                        <p class="text-slate-400">Carregando disciplinas...</p>
                    </div>
                </div>
                <button id="btn-salvar-metas" class="w-full bg-blue-600 text-white font-semibold mt-4">Salvar e Distribuir Horas</button>
              </div>

              <div class="card">
                <h2>Progresso por Disciplina</h2>
                <div id="progressoDisciplinas"></div>
              </div>
              
              <div class="card">
                  <h2>Revis√µes Agendadas</h2>
                  <div id="listaRevisoes"></div>
              </div>
            </div>
          </div>
      </div>

      <!-- Aba de Simulados -->
      <div id="tab-content-simulados" class="tab-content hidden">
          <div class="card">
              <h2>Simulados de Provas Anteriores</h2>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  <div>
                      <label for="filtro-banca" class="block font-semibold mb-1">Banca:</label>
                      <select id="filtro-banca" class="w-full">
                          <option value="">Todas</option>
                          <option value="FGV">FGV</option>
                      </select>
                  </div>
                  <div>
                      <label for="filtro-cargo" class="block font-semibold mb-1">Cargo:</label>
                      <select id="filtro-cargo" class="w-full">
                           <option value="">Todos</option>
                           <option value="Assistente Legislativo">Assistente Legislativo</option>
                      </select>
                  </div>
                   <div>
                      <label for="filtro-ano" class="block font-semibold mb-1">Ano:</label>
                      <select id="filtro-ano" class="w-full">
                           <option value="">Todos</option>
                           <option value="2018">2018</option>
                      </select>
                  </div>
              </div>
              <div id="lista-simulados" class="space-y-3">
                  <p class="text-slate-500">Carregando simulados...</p>
              </div>
          </div>
      </div>

      <!-- Aba de Reda√ß√£o -->
      <div id="tab-content-redacao" class="tab-content hidden">
          <div class="card">
              <h2>Banco de Temas de Reda√ß√£o - FGV</h2>
              <div id="lista-temas-redacao" class="space-y-4"></div>
          </div>
      </div>
      
      <!-- Aba de Progresso -->
      <div id="tab-content-progresso" class="tab-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <div class="card">
                    <h2>Evolu√ß√£o de Quest√µes</h2>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-center mb-4">
                        <div><p class="font-bold text-2xl" id="evolucaoDiaria">0</p><p class="text-sm text-slate-500">Hoje</p></div>
                        <div><p class="font-bold text-2xl" id="evolucaoSemanal">0</p><p class="text-sm text-slate-500">Semana</p></div>
                        <div><p class="font-bold text-2xl" id="evolucaoMensal">0</p><p class="text-sm text-slate-500">M√™s</p></div>
                        <div><p class="font-bold text-2xl" id="evolucaoTotal">0</p><p class="text-sm text-slate-500">Total</p></div>
                    </div>
                    <canvas id="graficoEvolucaoPizza" height="200"></canvas>
                </div>
            </div>
            <div>
                <div class="card">
                    <h2>Hist√≥rico de Desempenho</h2>
                    <div class="flex flex-col sm:flex-row gap-4 items-center mb-4">
                      <div class="w-full sm:w-auto flex-grow">
                          <label for="filtroPeriodoDesempenho" class="block font-semibold mb-1">Per√≠odo:</label>
                          <select id="filtroPeriodoDesempenho" class="w-full">
                            <option value="semana">√öltima semana</option>
                            <option value="mes">√öltimo m√™s</option>
                            <option value="total" selected>Todo hist√≥rico</option>
                          </select>
                      </div>
                      <div class="w-full sm:w-auto pt-0 sm:pt-7">
                          <button id="btnCompararMeta" class="w-full bg-green-500 text-white font-semibold">Comparar com Meta</button>
                      </div>
                    </div>
                    <div class="mb-6">
                      <canvas id="graficoDesempenhoModos" height="200"></canvas>
                    </div>
                    <div>
                      <canvas id="graficoLinhaModos" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <!-- Aba de Edital -->
      <div id="tab-content-edital" class="tab-content hidden">
          <div class="card" id="card-edital-para-pdf">
              <div class="flex justify-between items-center" id="edital-header">
                <div>
                    <h2>Edital Verticalizado</h2>
                    <p class="text-lg font-semibold text-slate-700 -mt-4 mb-4">Concurso: Assembleia Legislativa de Rond√¥nia (ALE-RO) - Base 2018</p>
                </div>
                <button id="btn-download-pdf" class="bg-blue-600 text-white font-semibold">Baixar PDF</button>
              </div>
              <div id="edital-verticalizado-container" class="mt-4 space-y-4"></div>
          </div>
      </div>
      
      <!-- Aba de Perfil -->
       <div id="tab-content-perfil" class="tab-content hidden">
          <div class="card">
            <div class="flex justify-between items-center">
                <h2>Meu Perfil</h2>
                <button id="btn-download-relatorio" class="bg-teal-500 text-white font-semibold">Baixar Relat√≥rio PDF</button>
            </div>
            <div id="perfil-usuario" class="space-y-2 mt-4"></div>
            
            <div class="mt-6">
                <h3 class="text-xl font-semibold text-blue-800 border-b pb-2 mb-2">üèÖ Minhas Medalhas</h3>
                <div id="listaMedalhas" class="flex flex-wrap gap-4 mt-2"></div>
            </div>
             <div class="mt-6">
                <h3 class="text-xl font-semibold text-blue-800 border-b pb-2 mb-2">üèÜ Hall da Fama</h3>
                <div id="hall-da-fama" class="space-y-2"></div>
            </div>
             <div class="mt-6">
                <h3 class="text-xl font-semibold text-blue-800 border-b pb-2 mb-2">üìù Minhas Reda√ß√µes</h3>
                <div id="lista-redacoes-salvas" class="space-y-2"></div>
            </div>
          </div>
      </div>

      <!-- Aba de Ranking -->
      <div id="tab-content-ranking" class="tab-content hidden">
          <div class="card">
              <h2>Ranking Geral</h2>
              <div id="ranking-geral-container" class="space-y-2"></div>
          </div>
      </div>

      <!-- Aba de Desafios -->
      <div id="tab-content-desafios" class="tab-content hidden">
          <div class="card">
              <h2>Desafios 1x1</h2>
              <div id="desafios-container" class="space-y-3"></div>
          </div>
      </div>

    </div>
  </div>

  <!-- Modal de Quest√µes -->
  <div id="modal-questoes" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h2 id="modal-titulo" class="m-0 p-0 border-0">Simulado</h2>
            <button id="btn-fechar-modal" class="text-2xl font-bold">&times;</button>
          </div>
          <div id="modal-corpo"></div>
      </div>
  </div>

  <!-- Modal de Reda√ß√£o -->
  <div id="modal-redacao" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[95vh] flex flex-col">
          <div class="flex justify-between items-center mb-4">
            <h2 id="modal-redacao-titulo" class="m-0 p-0 border-0">Escrever Reda√ß√£o</h2>
            <button id="btn-fechar-modal-redacao" class="text-2xl font-bold">&times;</button>
          </div>
          <div class="overflow-y-auto flex-grow">
              <div id="redacao-instrucoes" class="mb-4"></div>
              <textarea id="redacao-texto-usuario" placeholder="Comece a escrever sua reda√ß√£o aqui..."></textarea>
              <div id="correcao-container" class="mt-4 hidden"></div>
          </div>
          <div class="pt-4 border-t mt-4 flex justify-end gap-4">
              <button id="btn-imprimir-redacao" class="bg-gray-500 text-white font-semibold hidden">Imprimir PDF</button>
              <button id="btn-corrigir-redacao" class="bg-green-500 text-white font-semibold">Corrigir Reda√ß√£o</button>
          </div>
      </div>
  </div>


  <!-- SCRIPTS -->
  <script type="module">
    // =========================
    // CONFIGURA√á√ÉO DO FIREBASE
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDqHXjI3lTXMgRWItxaP7An-JZe04YQ-Sg",
      authDomain: "gfconcursos-app.firebaseapp.com",
      databaseURL: "https://gfconcursos-app-default-rtdb.firebaseio.com",
      projectId: "gfconcursos-app",
      storageBucket: "gfconcursos-app.firebasestorage.app",
      messagingSenderId: "615439428502",
      appId: "1:615439428502:web:b399549c3969e052098bb7"
    };

    // Importa√ß√µes do Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDocs, getDoc, query, where, orderBy, Timestamp, updateDoc, setDoc, documentId, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Vari√°veis globais
    let graficoPizza = null;
    let graficoDesempenhoModos = null;
    let graficoLinhaModos = null;
    let metaAcertosGlobal = 0;
    const modalCorpo = document.getElementById('modal-corpo');
    
    // Vari√°veis de estado do Simulado
    let questoesDoSimulado = [];
    let questaoAtualIndex = 0;
    let pontuacao = 0;
    let temaRedacaoAtual = null;
    
    // =========================
    // L√ìGICA DE NAVEGA√á√ÉO POR ABAS
    // =========================
    const tabsContainer = document.getElementById('tabs-container');
    const tabButtons = tabsContainer.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    document.getElementById('menu-toggle').addEventListener('click', () => {
        document.getElementById('nav-menu').classList.toggle('hidden');
    });

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.dataset.tab;
            
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            tabContents.forEach(content => {
                if (content.id === `tab-content-${tab}`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
            if (window.innerWidth < 768) {
                 document.getElementById('nav-menu').classList.add('hidden');
            }
        });
    });

    // =========================
    // L√ìGICA DE AUTENTICA√á√ÉO
    // =========================
    const authStatus = document.getElementById('auth-status');
    const loginView = document.getElementById('login-view');
    const logoutView = document.getElementById('logout-view');
    const welcomeMessage = document.getElementById('welcome-message');
    const mainContent = document.getElementById('main-content');
    const authContainer = document.getElementById('auth-container');


    onAuthStateChanged(auth, user => {
        if (user) {
            authStatus.textContent = ``;
            mainContent.classList.remove('hidden');
            tabsContainer.classList.remove('hidden');
            authContainer.classList.add('hidden');
            document.querySelector('.tab-button[data-tab="estudo"]').click();
            inicializarApp(user);
        } else {
            authStatus.textContent = 'Voc√™ n√£o est√° conectado.';
            mainContent.classList.add('hidden');
            tabsContainer.classList.add('hidden');
            authContainer.classList.remove('hidden');
            limparDadosUI();
        }
    });

    document.getElementById('btn-login').addEventListener('click', () => {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        if (!email || !password) {
            alert("Por favor, preencha e-mail e senha.");
            return;
        }
        signInWithEmailAndPassword(auth, email, password)
            .catch(error => alert('Erro no login: ' + error.message));
    });

    document.getElementById('btn-logout').addEventListener('click', () => {
        signOut(auth);
    });

    function limparDadosUI() {
        ['seletorDisciplina', 'listaAssuntos', 'progressoDisciplinas', 'evolucaoDiaria', 'evolucaoSemanal', 'evolucaoMensal', 'evolucaoTotal', 'listaRevisoes', 'edital-verticalizado-container', 'perfil-usuario', 'listaMedalhas', 'hall-da-fama', 'ranking-geral-container', 'desafios-container']
        .forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if(el.tagName === 'SPAN') el.textContent = '0';
                else el.innerHTML = '';
            }
        });
        
        if (graficoPizza) { graficoPizza.destroy(); graficoPizza = null; }
        if (graficoDesempenhoModos) { graficoDesempenhoModos.destroy(); graficoDesempenhoModos = null; }
        if (graficoLinhaModos) { graficoLinhaModos.destroy(); graficoLinhaModos = null; }
    }
    
    // =========================
    // FUN√á√ÉO AUXILIAR
    // =========================
    function calcularProgresso(metaHoras, horasEstudadas) {
      if (!metaHoras || metaHoras === 0) return 0;
      return Math.min((horasEstudadas / metaHoras) * 100, 100);
    }

    // =========================
    // INICIALIZA√á√ÉO DO APLICATIVO
    // =========================
    async function inicializarApp(user) {
        const userDoc = await getDoc(doc(db, "usuarios", user.uid));
        if(userDoc.exists()) {
            const userData = userDoc.data();
            metaAcertosGlobal = userData.metaAcertos || 80;
            document.getElementById('meta-geral-horas').value = userData.metaGeralHoras || '';
            const cicloNome = userData.cicloAtualNome || 'Ciclo 1: Rumo √† Aprova√ß√£o (ALE-RO)';
            document.getElementById('ciclo-nome-input').value = cicloNome;
            await carregarPrioridades(user.uid, userData.prioridadeDisciplinas);
        } else {
            await carregarPrioridades(user.uid, []);
        }
        
        const funcoesCarregamento = [
            carregarDisciplinas,
            () => carregarProgressoDisciplinas(user.uid),
            () => carregarEvolucaoQuestoes(user.uid),
            () => carregarRevisoes(user.uid),
            () => carregarDesempenhoPorModo(user.uid),
            () => carregarEvolucaoCronologicaPorModo(user.uid),
            gerarEditalVerticalizado,
            () => carregarPerfil(user.uid),
            () => carregarMedalhas(user.uid),
            () => carregarRanking(user.uid),
            () => carregarDesafios(user.uid),
            carregarSimulados,
            carregarTemasRedacao
        ];
        
        for(const funcao of funcoesCarregamento) {
            try {
                await funcao();
            } catch (error) {
                console.error(`Erro ao executar ${funcao.name}:`, error);
            }
        }

        // Adiciona listeners
        document.getElementById('seletorDisciplina').addEventListener('change', carregarAssuntos);
        document.getElementById('btn-revisao-inteligente').addEventListener('click', () => iniciarRevisaoInteligente(user.uid));
        document.getElementById('filtroPeriodoDesempenho').addEventListener('change', () => {
            carregarDesempenhoPorModo(user.uid);
            carregarEvolucaoCronologicaPorModo(user.uid);
        });
        document.getElementById('btnCompararMeta').addEventListener('click', () => toggleLinhaMeta());
        document.getElementById('btn-download-pdf').addEventListener('click', baixarEditalPDF);
        document.getElementById('btn-iniciar-pratica').addEventListener('click', () => {
            const idDisciplina = document.getElementById("seletorDisciplina").value;
            if (!idDisciplina) {
                alert("Por favor, escolha uma disciplina no 'Menu de Disciplinas' para praticar.");
                return;
            }
            iniciarSimulado(idDisciplina, null, null, 'pratica');
        });
        document.getElementById('btn-download-relatorio').addEventListener('click', () => baixarRelatorioPDF(user.uid));
        document.getElementById('btn-salvar-metas').addEventListener('click', () => salvarMetasEDistribuir(user.uid));
    }
    
    // =========================
    // 1. MENU DE DISCIPLINAS E ASSUNTOS
    // =========================
    async function carregarDisciplinas() {
      const q = query(collection(db, "disciplinas"), orderBy("nome"));
      const snapshot = await getDocs(q);
      const seletor = document.getElementById("seletorDisciplina");
      seletor.innerHTML = '<option value="">-- Escolha uma disciplina --</option>';
      snapshot.forEach(doc => {
        seletor.innerHTML += `<option value="${doc.id}">${doc.data().nome}</option>`;
      });
    }

    async function carregarAssuntos() {
      const idDisciplina = document.getElementById("seletorDisciplina").value;
      const container = document.getElementById("listaAssuntos");
      container.innerHTML = "";

      if (!idDisciplina) return;

      const disciplinaDoc = await getDoc(doc(db, "disciplinas", idDisciplina));
      if (!disciplinaDoc.exists()) return;
      
      const assuntos = disciplinaDoc.data().assuntos || {};

      for (const assuntoId in assuntos) {
        const a = assuntos[assuntoId];
        container.innerHTML += `
          <div class="border p-3 rounded-lg">
            <h4 class="font-bold text-lg">${a.nome}</h4>
            <p class="text-sm text-gray-600 my-2">${a.resumo || 'Sem resumo.'}</p>
            <button data-disciplina-id="${idDisciplina}" data-assunto-nome="${a.nome}" class="btn-praticar-assunto w-full bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold">Praticar por assunto</button>
          </div>
        `;
      }
      
      document.querySelectorAll('.btn-praticar-assunto').forEach(btn => btn.addEventListener('click', (e) => iniciarSimulado(e.currentTarget.dataset.disciplinaId, e.currentTarget.dataset.assuntoNome, null, 'pratica')));
    }

    // =========================
    // 2. METAS, PROGRESSO E PRIORIDADES
    // =========================
    
    async function carregarPrioridades(uid, prioridadesSalvas = []) {
        const container = document.getElementById('lista-prioridades');
        const q = query(collection(db, "disciplinas"), orderBy("nome"));
        const snapshot = await getDocs(q);
        let disciplinas = snapshot.docs.map(doc => ({ id: doc.id, nome: doc.data().nome }));

        disciplinas.sort((a, b) => {
            const indexA = prioridadesSalvas.indexOf(a.id);
            const indexB = prioridadesSalvas.indexOf(b.id);
            if (indexA > -1 && indexB > -1) return indexA - indexB;
            if (indexA > -1) return -1;
            if (indexB > -1) return 1;
            return 0;
        });

        container.innerHTML = disciplinas.map(d => `
            <div class="priority-item p-2 border rounded bg-gray-50" draggable="true" data-id="${d.id}">
                ${d.nome}
            </div>
        `).join('');

        const draggables = container.querySelectorAll('.priority-item');
        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
            draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
        });

        container.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(container, e.clientY);
            const dragging = document.querySelector('.dragging');
            if (afterElement == null) {
                container.appendChild(dragging);
            } else {
                container.insertBefore(dragging, afterElement);
            }
        });
    }
    
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.priority-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    async function salvarMetasEDistribuir(uid) {
        const metaGeralHoras = parseInt(document.getElementById('meta-geral-horas').value);
        const nomeCiclo = document.getElementById('ciclo-nome-input').value.trim();

        if (isNaN(metaGeralHoras) || metaGeralHoras <= 0) {
            alert("Por favor, defina uma meta de horas v√°lida.");
            return;
        }

        const container = document.getElementById('lista-prioridades');
        const prioridadeDisciplinas = [...container.querySelectorAll('.priority-item')].map(el => el.dataset.id);
        
        const totalDisciplinas = prioridadeDisciplinas.length;
        const pesos = Array.from({ length: totalDisciplinas }, (_, i) => totalDisciplinas - i);
        const somaPesos = pesos.reduce((acc, peso) => acc + peso, 0);

        const metasPorDisciplina = {};
        prioridadeDisciplinas.forEach((id, index) => {
            const horas = (metaGeralHoras * pesos[index]) / somaPesos;
            metasPorDisciplina[id] = horas;
        });

        const userDocRef = doc(db, "usuarios", uid);
        try {
            await setDoc(userDocRef, { metaGeralHoras, prioridadeDisciplinas, metasPorDisciplina, cicloAtualNome: nomeCiclo }, { merge: true });
            alert("Metas salvas e horas distribu√≠das com sucesso!");
            await carregarProgressoDisciplinas(uid);
        } catch(e) {
            console.error("Erro ao salvar metas:", e);
            alert("N√£o foi poss√≠vel salvar as metas. Verifique as regras de seguran√ßa do Firestore para permitir a escrita na cole√ß√£o 'usuarios'.");
        }
    }

    async function carregarProgressoDisciplinas(uid) {
        const container = document.getElementById("progressoDisciplinas");
        container.innerHTML = "<p class='text-slate-500'>Carregando progresso...</p>";
        
        const userDoc = await getDoc(doc(db, "usuarios", uid));
        const metasPorDisciplina = userDoc.exists() ? userDoc.data().metasPorDisciplina || {} : {};

        const qTempo = query(collection(db, "registro_tempo"), where("usuarioId", "==", uid));
        const registrosSnapshot = await getDocs(qTempo);
        
        const tempoPorDisciplina = {};
        registrosSnapshot.forEach(r => {
            const data = r.data();
            tempoPorDisciplina[data.disciplinaId] = (tempoPorDisciplina[data.disciplinaId] || 0) + data.minutos;
        });

        const disciplinasSnapshot = await getDocs(query(collection(db, "disciplinas"), orderBy("nome")));
        container.innerHTML = "";
        
        if (disciplinasSnapshot.empty) {
            container.innerHTML = "<p class='text-slate-500'>Nenhuma disciplina encontrada.</p>";
            return;
        }

        disciplinasSnapshot.forEach(docSnap => {
            const d = docSnap.data();
            const idDisciplina = docSnap.id;
            const metaHoras = metasPorDisciplina[idDisciplina] || 0;
            const minutosEstudados = tempoPorDisciplina[idDisciplina] || 0;
            const horasEstudadas = minutosEstudados / 60;
            const percentual = calcularProgresso(metaHoras, horasEstudadas);
            container.innerHTML += `
                <div class="mb-4">
                  <p class="font-semibold">${d.nome} ‚Äì ${horasEstudadas.toFixed(1)}h / ${metaHoras.toFixed(1)}h</p>
                  <div class="w-full bg-gray-200 rounded-full h-4 mt-1">
                    <div class="bg-green-500 h-4 rounded-full" style="width: ${percentual}%;"></div>
                  </div>
                </div>
            `;
        });
    }

    // =========================
    // 3. PAINEL DE EVOLU√á√ÉO E GR√ÅFICO DE PIZZA
    // =========================
    async function carregarEvolucaoQuestoes(uid) {
        const q = query(collection(db, "historico_questoes"), where("usuarioId", "==", uid));
        const snapshot = await getDocs(q);

        let hoje = 0, semana = 0, mes = 0, total = 0;
        const agora = new Date();
        const inicioHoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
        const inicioSemana = new Date(agora); inicioSemana.setDate(agora.getDate() - agora.getDay());
        const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);

        snapshot.forEach(doc => {
            const dataString = doc.data().dataResposta;
            if (typeof dataString === 'string') {
                 const data = new Date(dataString);
                 if(!isNaN(data.getTime())) {
                    total++;
                    if (data >= inicioHoje) hoje++;
                    if (data >= inicioSemana) semana++;
                    if (data >= inicioMes) mes++;
                 }
            }
        });
        document.getElementById("evolucaoDiaria").textContent = hoje;
        document.getElementById("evolucaoSemanal").textContent = semana;
        document.getElementById("evolucaoMensal").textContent = mes;
        document.getElementById("evolucaoTotal").textContent = total;
        gerarGraficoPizza([hoje, semana, mes, total]);
    }

    function gerarGraficoPizza(valores) {
        const ctx = document.getElementById("graficoEvolucaoPizza").getContext("2d");
        if (graficoPizza) graficoPizza.destroy();
        graficoPizza = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Hoje', 'Semana', 'M√™s', 'Total'],
                datasets: [{
                    data: valores,
                    backgroundColor: ['#4BC0C0', '#FFCE56', '#36A2EB', '#FF6384']
                }]
            }
        });
    }

    // =========================
    // 4. PR√ÅTICA DE QUEST√ïES E SIMULADO
    // =========================
    async function buscarQuestoes(idDisciplina, nomeAssunto, quantidade) {
        const dificuldade = document.getElementById("nivelDificuldade").value;
        
        let q = query(collection(db, "questoes"));

        if (idDisciplina) {
             q = query(q, where("disciplinaId", "==", idDisciplina));
             if (nomeAssunto) q = query(q, where("nomeAssunto", "==", nomeAssunto));
        }
        if (dificuldade) q = query(q, where("dificuldade", "==", dificuldade));
        
        const snapshot = await getDocs(q);
        let questoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        questoes.sort(() => Math.random() - 0.5); // Embaralha para variedade

        return questoes.slice(0, quantidade);
    }
    
    async function iniciarSimulado(idDisciplina, nomeAssunto, questoesPredefinidas = null, modo = "pratica") {
        const uid = auth.currentUser ? auth.currentUser.uid : null;
        
        let quantidade;
        if (modo === 'revisao') {
            quantidade = parseInt(document.getElementById("quantidadeQuestoesInteligente").value) || 20;
        } else {
            quantidade = parseInt(document.getElementById("quantidadeQuestoes").value) || 10;
        }

        const questoes = questoesPredefinidas || await buscarQuestoes(idDisciplina, nomeAssunto, quantidade);
       
        if (questoes.length === 0) {
            alert("Nenhuma quest√£o encontrada com os filtros selecionados.");
            return;
        }
        
        if (questoes.length < quantidade && !questoesPredefinidas) {
            alert(`Voc√™ solicitou ${quantidade} quest√µes, mas apenas ${questoes.length} foram encontradas com os filtros atuais. O simulado iniciar√° com as quest√µes dispon√≠veis.`);
        }

        questoesDoSimulado = questoes;
        questaoAtualIndex = 0;
        pontuacao = 0;
        
        document.getElementById('modal-titulo').textContent = `Simulado de ${nomeAssunto || idDisciplina || 'Revis√£o'}`;
        exibirQuestao();
        
        const modal = document.getElementById('modal-questoes');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    };

    function exibirQuestao() {
        if (questaoAtualIndex >= questoesDoSimulado.length) {
            exibirResultadoFinal();
            return;
        }

        const q = questoesDoSimulado[questaoAtualIndex];
        let alternativasHTML = (q.alternativas || []).map(alt => 
            `<button class="option-button p-2 border rounded">${alt}</button>`
        ).join('');

        modalCorpo.innerHTML = `
            <div class="mb-4">
              <p class="font-semibold">Quest√£o ${questaoAtualIndex + 1}/${questoesDoSimulado.length}: (${q.dificuldade})</p>
              <p class="my-2">${q.texto || q.enunciado}</p>
              <div class="mt-4">${alternativasHTML}</div>
              <div id="feedback-container" class="mt-2"></div>
              <button id="btn-proxima-questao" class="hidden w-full bg-blue-500 text-white font-semibold mt-4 py-2">Pr√≥xima Quest√£o</button>
            </div>
        `;

        modalCorpo.querySelectorAll('.option-button').forEach(btn => {
            btn.addEventListener('click', (e) => verificarResposta(e.target.textContent));
        });
        document.getElementById('btn-proxima-questao').addEventListener('click', () => {
            questaoAtualIndex++;
            exibirQuestao();
        });
    }
    
    function verificarResposta(respostaSelecionada) {
        const q = questoesDoSimulado[questaoAtualIndex];
        const acertou = respostaSelecionada === q.respostaCorreta;
        const feedbackContainer = modalCorpo.querySelector('#feedback-container');
        
        if (acertou) {
            pontuacao++;
            feedbackContainer.innerHTML = `<p class="text-green-600 font-semibold">Resposta Correta!</p>`;
        } else {
            feedbackContainer.innerHTML = `<p class="text-red-600 font-semibold">Resposta Incorreta!</p><p><b>Correta:</b> ${q.respostaCorreta}</p>`;
        }
        
        if (q.comentario) {
            feedbackContainer.innerHTML += `<p class="text-sm mt-2 p-2 bg-gray-100 rounded">${q.comentario}</p>`;
        }

        modalCorpo.querySelectorAll('.option-button').forEach(btn => {
            btn.disabled = true;
            if (btn.textContent === q.respostaCorreta) {
                btn.classList.add('correct');
            } else if (btn.textContent === respostaSelecionada) {
                btn.classList.add('incorrect');
            }
        });
        
        modalCorpo.querySelector('#btn-proxima-questao').classList.remove('hidden');
    }

    function exibirResultadoFinal() {
        const total = questoesDoSimulado.length;
        const percentual = total > 0 ? (pontuacao / total * 100).toFixed(1) : 0;
        modalCorpo.innerHTML = `
            <div class="text-center">
                <h3 class="text-2xl font-bold">Simulado Conclu√≠do!</h3>
                <p class="text-lg mt-4">Voc√™ acertou ${pontuacao} de ${total} quest√µes.</p>
                <p class="text-4xl font-bold my-4">${percentual}% de acerto</p>
                <button id="btn-fechar-resultado" class="w-full bg-slate-600 text-white font-semibold py-2">Fechar</button>
            </div>
        `;
        document.getElementById('btn-fechar-resultado').addEventListener('click', () => {
             document.getElementById('modal-questoes').classList.add('hidden');
        });
    }


    document.getElementById('btn-fechar-modal').addEventListener('click', () => {
        const modal = document.getElementById('modal-questoes');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // =========================
    // 5. REVIS√ÉO INTELIGENTE
    // =========================
    async function iniciarRevisaoInteligente(uid) {
        const quantidade = parseInt(document.getElementById("quantidadeQuestoesInteligente").value) || 20;

        const allQuestoesSnapshot = await getDocs(collection(db, "questoes"));
        let allQuestoes = allQuestoesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        allQuestoes.sort((a, b) => {
            const perfA = (a.acertosUsuario || 0) - (a.errosUsuario || 0);
            const perfB = (b.acertosUsuario || 0) - (b.errosUsuario || 0);
            return perfA - perfB;
        });
        
        let treino = allQuestoes.slice(0, quantidade);

        await iniciarSimulado(null, 'Revis√£o Inteligente', treino, "revisao");
    }


    // =========================
    // 6. REVIS√ÉO ESPA√áADA
    // =========================
    async function carregarRevisoes(uid) {
        const container = document.getElementById("listaRevisoes");
        container.innerHTML = "<p class='text-slate-500'>Carregando revis√µes...</p>";

        const q = query(collection(db, "revisoes"), where("usuarioId", "==", uid));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            container.innerHTML = "<p class='text-slate-500'>Nenhuma revis√£o encontrada.</p>";
            return;
        }

        const agora = new Date();
        let revisoesPendentesHTML = "";
        let revisoesPendentesCount = 0;

        snapshot.forEach(doc => {
            const r = doc.data();
            if (r.status !== 'pendente') return;

            const revisoesAgendadas = r.revisoesAgendadas || [];
            revisoesAgendadas.forEach(dataStr => {
                const dataRevisao = new Date(dataStr);
                if (dataRevisao <= agora) {
                    revisoesPendentesCount++;
                    revisoesPendentesHTML += `
                        <div class="border p-2 rounded mb-2 bg-yellow-100">
                          <p><strong>${r.nomeDisciplina}</strong> - ${r.nomeAssunto}</p>
                          <p class="text-sm">Revis√£o agendada para: ${dataRevisao.toLocaleDateString()}</p>
                        </div>
                    `;
                }
            });
        });

        if (revisoesPendentesCount === 0) {
             container.innerHTML = "<p class='text-slate-500'>Nenhuma revis√£o pendente. Bom trabalho!</p>";
        } else {
            container.innerHTML = revisoesPendentesHTML;
        }
    }

    // =========================
    // 7. HIST√ìRICO DE DESEMPENHO
    // =========================
    function getDateRange(periodo) {
        const agora = new Date();
        let dataInicio;
        if (periodo === 'semana') {
            dataInicio = new Date(agora.setDate(agora.getDate() - 7));
        } else if (periodo === 'mes') {
            dataInicio = new Date(agora.setMonth(agora.getMonth() - 1));
        } else {
            dataInicio = new Date(0);
        }
        return Timestamp.fromDate(dataInicio);
    }

    async function carregarDesempenhoPorModo(uid) {
        const periodo = document.getElementById('filtroPeriodoDesempenho').value;
        const dataInicio = getDateRange(periodo).toDate();

        const q = query(collection(db, "historico_treinos"), where("usuarioId", "==", uid));
        const snapshot = await getDocs(q);

        const dados = {
            simulado: { acertos: 0, erros: 0 },
            pratica: { acertos: 0, erros: 0 }
        };

        snapshot.forEach(doc => {
            const treino = doc.data();
            const dataTreino = new Date(treino.data);
            if (dataTreino >= dataInicio) {
                if (dados[treino.modo]) {
                    dados[treino.modo].acertos += treino.acertos || 0;
                    dados[treino.modo].erros += treino.erros || 0;
                }
            }
        });

        const ctx = document.getElementById('graficoDesempenhoModos').getContext('2d');
        if(graficoDesempenhoModos) graficoDesempenhoModos.destroy();
        graficoDesempenhoModos = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Simulado', 'Pr√°tica'],
                datasets: [
                    {
                        label: 'Acertos',
                        data: [dados.simulado.acertos, dados.pratica.acertos],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    },
                    {
                        label: 'Erros',
                        data: [dados.simulado.erros, dados.pratica.erros],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    }
                ]
            },
            options: { responsive: true, plugins: { title: { display: true, text: 'Desempenho por Modo de Treino' } } }
        });
    }

    async function carregarEvolucaoCronologicaPorModo(uid) {
        const periodo = document.getElementById('filtroPeriodoDesempenho').value;
        const dataInicio = getDateRange(periodo).toDate();
        
        const q = query(collection(db, "historico_treinos"), where("usuarioId", "==", uid));
        const snapshot = await getDocs(q);

        const dadosPorData = {}; 
        snapshot.forEach(doc => {
            const treino = doc.data();
            const dataTreino = new Date(treino.data);

            if (dataTreino >= dataInicio) {
                const data = dataTreino.toISOString().split('T')[0];
                if (!dadosPorData[data]) {
                    dadosPorData[data] = { acertos: 0, total: 0 };
                }
                dadosPorData[data].acertos += treino.acertos;
                dadosPorData[data].total += (treino.acertos + treino.erros);
            }
        });

        const labels = Object.keys(dadosPorData).sort();
        const dataPoints = labels.map(label => {
            const dia = dadosPorData[label];
            return dia.total > 0 ? (dia.acertos / dia.total) * 100 : 0;
        });

        const ctx = document.getElementById('graficoLinhaModos').getContext('2d');
        if(graficoLinhaModos) graficoLinhaModos.destroy();
        graficoLinhaModos = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '% de Acertos',
                    data: dataPoints,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: { responsive: true, plugins: { title: { display: true, text: 'Evolu√ß√£o de Acertos ao Longo do Tempo' } } }
        });
    }

    function toggleLinhaMeta() {
        if (!graficoLinhaModos) return;

        const metaDataset = {
            label: `Meta (${metaAcertosGlobal}%)`,
            data: Array(graficoLinhaModos.data.labels.length).fill(metaAcertosGlobal),
            borderColor: 'rgba(255, 99, 132, 1)',
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0
        };

        const metaIndex = graficoLinhaModos.data.datasets.findIndex(ds => ds.label.startsWith('Meta'));

        if (metaIndex > -1) {
            graficoLinhaModos.data.datasets.splice(metaIndex, 1);
        } else {
            graficoLinhaModos.data.datasets.push(metaDataset);
        }
        graficoLinhaModos.update();
    }
    
    // =========================
    // 8. EDITAL VERTICALIZADO
    // =========================
    const editalALERO = {
        "L√≠ngua Portuguesa": ["Interpreta√ß√£o de textos: compreens√£o de textos verbais e n√£o verbais","Morfologia: classes de palavras (verbos, pronomes, substantivos, etc.) e suas flex√µes","Sintaxe: concord√¢ncia verbal e nominal, reg√™ncia, crase","Pontua√ß√£o: uso correto dos sinais de pontua√ß√£o","Problemas da l√≠ngua culta: ortografia, sem√¢ntica, hom√¥nimos e par√¥nimos"],
        "Hist√≥ria e Geografia de Rond√¥nia": ["Processo de coloniza√ß√£o e ciclos econ√¥micos (borracha, cassiterita)","Cria√ß√£o do Territ√≥rio Federal do Guapor√© e do Estado de Rond√¥nia","Aspectos f√≠sicos: relevo, hidrografia e clima","Popula√ß√£o e demografia"],
        "Direito Administrativo": ["Organiza√ß√£o administrativa: administra√ß√£o direta e indireta","Atos administrativos: atributos, elementos, anula√ß√£o e revoga√ß√£o","Poderes da Administra√ß√£o: vinculado, discricion√°rio, hier√°rquico, disciplinar e de pol√≠cia","Licita√ß√µes e Contratos (Lei 14.133/2021)","Servidores p√∫blicos: regime jur√≠dico, direitos e deveres"],
        "Legisla√ß√£o Estadual": ["Constitui√ß√£o do Estado de Rond√¥nia: principais t√≠tulos e cap√≠tulos","Regimento Interno da ALE-RO: estrutura e funcionamento"],
        "Direito Constitucional": ["Princ√≠pios fundamentais da Rep√∫blica","Direitos e garantias fundamentais (Art. 5¬∫)","Organiza√ß√£o do Estado: Uni√£o, Estados, Munic√≠pios","Poder Legislativo: estrutura e atribui√ß√µes"],
        "Gest√£o de Pessoas": ["Motiva√ß√£o no servi√ßo p√∫blico", "Lideran√ßa e estilos de lideran√ßa", "Trabalho em equipe e gest√£o de conflitos"],
        "Matem√°tica": ["Opera√ß√µes com n√∫meros reais", "Porcentagem e juros simples", "Regra de tr√™s simples e composta"],
        "Racioc√≠nio L√≥gico": ["Estruturas l√≥gicas e l√≥gica de argumenta√ß√£o", "Sequ√™ncias l√≥gicas de n√∫meros, letras e figuras", "Problemas de l√≥gica com diagramas e tabelas"],
        "No√ß√µes de Inform√°tica": ["Sistema Operacional Windows: arquivos e pastas", "Editor de textos: Microsoft Word", "Planilhas eletr√¥nicas: Microsoft Excel", "Conceitos de hardware e software", "Internet: navega√ß√£o, e-mail e seguran√ßa da informa√ß√£o"],
        "Administra√ß√£o Geral": ["Reda√ß√£o oficial: padr√µes e normas","Arquivologia: conceitos fundamentais e gest√£o de documentos","Administra√ß√£o de recursos materiais e patrimoniais","Conceitos de administra√ß√£o p√∫blica e governan√ßa"]
    };

    function gerarEditalVerticalizado() {
        const container = document.getElementById('edital-verticalizado-container');
        container.innerHTML = '';
        for (const disciplina in editalALERO) {
            let assuntosHTML = editalALERO[disciplina].map(assunto => `<li class="ml-4 list-disc">${assunto}</li>`).join('');
            container.innerHTML += `
                <div class="border p-4 rounded-lg">
                    <h3 class="font-bold text-lg text-blue-700">${disciplina}</h3>
                    <ul class="mt-2">${assuntosHTML}</ul>
                </div>
            `;
        }
    }

    async function baixarEditalPDF() {
        alert("Gerando seu PDF. Aguarde um momento...");
        const { jsPDF } = window.jspdf;
        const editalContainer = document.getElementById('card-edital-para-pdf');
        
        const button = editalContainer.querySelector('#btn-download-pdf');
        button.style.display = 'none';

        const canvas = await html2canvas(editalContainer);
        
        button.style.display = 'block';

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const ratio = imgWidth / imgHeight;
        
        let canvasHeightOnPdf = pdfWidth / ratio;
        let yPos = 0;
        let heightLeft = canvasHeightOnPdf;

        pdf.addImage(imgData, 'PNG', 0, yPos, pdfWidth, canvasHeightOnPdf);
        heightLeft -= pdfHeight;

        while (heightLeft > 0) {
            yPos -= pdfHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, yPos, pdfWidth, canvasHeightOnPdf);
            heightLeft -= pdfHeight;
        }
        
        pdf.save("edital-verticalizado-alero.pdf");
    }
    
    // =========================
    // 9. PERFIL, MEDALHAS E RANKING
    // =========================
    async function carregarPerfil(uid) {
        const container = document.getElementById('perfil-usuario');
        const userDoc = await getDoc(doc(db, "usuarios", uid)); 
        if(userDoc.exists()) {
            const data = userDoc.data();
            container.innerHTML = `<p><strong>Usu√°rio:</strong> ${auth.currentUser.email}</p><p><strong>Meta de Acertos:</strong> ${data.metaAcertos}%</p>`;
        }
    }
    
    async function baixarRelatorioPDF(uid) {
        alert("Gerando seu relat√≥rio em PDF. Aguarde um momento...");
        const { jsPDF } = window.jspdf;

        const userDoc = await getDoc(doc(db, "usuarios", uid));
        const qTempo = query(collection(db, "registro_tempo"), where("usuarioId", "==", uid));
        const qTreinos = query(collection(db, "historico_treinos"), where("usuarioId", "==", uid));

        const [userSnap, tempoSnap, treinosSnap] = await Promise.all([userDoc, getDocs(qTempo), getDocs(qTreinos)]);

        let totalMinutos = 0;
        tempoSnap.forEach(doc => totalMinutos += doc.data().minutos);

        let totalAcertos = 0;
        let totalQuestoes = 0;
        treinosSnap.forEach(doc => {
            totalAcertos += doc.data().acertos || 0;
            totalQuestoes += (doc.data().acertos || 0) + (doc.data().erros || 0);
        });
        const percentualGeral = totalQuestoes > 0 ? (totalAcertos / totalQuestoes * 100).toFixed(1) : 0;
        
        const reportHTML = `
            <div style="font-family: Arial, sans-serif; padding: 20px; width: 600px; border: 1px solid #ccc;">
                <h1 style="color: #1e3a8a; text-align: center; border-bottom: 2px solid #93c5fd; padding-bottom: 10px;">Relat√≥rio de Desempenho</h1>
                <h2 style="color: #3b82f6; margin-top: 20px;">Resumo Geral</h2>
                <p><strong>Usu√°rio:</strong> ${auth.currentUser.email}</p>
                <p><strong>Meta de Acertos:</strong> ${metaAcertosGlobal}%</p>
                <p><strong>Tempo Total de Estudo:</strong> ${(totalMinutos / 60).toFixed(1)} horas</p>
                <p><strong>Percentual Geral de Acertos:</strong> ${percentualGeral}%</p>
                <hr style="margin: 20px 0;" />
                <h2 style="color: #3b82f6;">Suas Conquistas</h2>
                <p>üèÜ Hall da Fama e Medalhas ser√£o adicionados aqui.</p>
            </div>
        `;
        
        const hiddenContainer = document.createElement('div');
        hiddenContainer.style.position = 'absolute';
        hiddenContainer.style.left = '-9999px';
        hiddenContainer.innerHTML = reportHTML;
        document.body.appendChild(hiddenContainer);

        html2canvas(hiddenContainer).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save("relatorio-de-desempenho.pdf");
            document.body.removeChild(hiddenContainer);
        });
    }

    async function carregarMedalhas(uid) {
        // Exemplo est√°tico
        const container = document.getElementById('listaMedalhas');
        container.innerHTML = `
          <div class="flex flex-col items-center border p-2 rounded w-24 text-center">
            <span class="text-3xl">üèÖ</span>
            <p class="text-xs mt-1">Regularidade</p>
          </div>
           <div class="flex flex-col items-center border p-2 rounded w-24 text-center">
            <span class="text-3xl">üéØ</span>
            <p class="text-xs mt-1">Meta Cumprida</p>
          </div>
        `;
    }

    // =========================
    // 10. RANKING E DESAFIOS
    // =========================
    async function carregarRanking(currentUid) {
        const container = document.getElementById('ranking-geral-container');
        container.innerHTML = "<p class='text-slate-500'>Carregando ranking...</p>";

        const usersSnapshot = await getDocs(collection(db, "usuarios"));
        const ranking = [];

        for(const userDoc of usersSnapshot.docs) {
            const uid = userDoc.id;
            const userData = userDoc.data();
            let pontuacao = 0;

            const qTempo = query(collection(db, "registro_tempo"), where("usuarioId", "==", uid));
            const qTreinos = query(collection(db, "historico_treinos"), where("usuarioId", "==", uid));
            
            const [tempoSnap, treinosSnap] = await Promise.all([getDocs(qTempo), getDocs(qTreinos)]);

            let totalMinutos = 0;
            tempoSnap.forEach(doc => totalMinutos += doc.data().minutos);
            pontuacao += totalMinutos; // 1 ponto por minuto estudado

            let totalAcertos = 0;
            treinosSnap.forEach(doc => totalAcertos += doc.data().acertos);
            pontuacao += totalAcertos * 10; // 10 pontos por acerto

            ranking.push({
                uid: uid,
                nome: userData.nome || userDoc.id,
                pontuacao: pontuacao
            });
        }
        
        ranking.sort((a, b) => b.pontuacao - a.pontuacao);

        container.innerHTML = ranking.map((user, index) => `
            <div class="flex items-center justify-between p-2 rounded ${user.uid === currentUid ? 'bg-blue-100' : ''}">
                <p class="font-semibold">${index + 1}. ${user.nome}</p>
                <p>${user.pontuacao.toLocaleString()} pontos</p>
            </div>
        `).join('');
    }

    async function carregarDesafios(currentUid) {
        const container = document.getElementById('desafios-container');
        container.innerHTML = "<p class='text-slate-500'>Carregando usu√°rios para desafiar...</p>";
        
        const usersSnapshot = await getDocs(collection(db, "usuarios"));
        let usersHTML = "";
        
        usersSnapshot.forEach(doc => {
            if (doc.id !== currentUid) {
                const user = doc.data();
                usersHTML += `
                    <div class="flex items-center justify-between p-3 border rounded-lg">
                        <p class="font-semibold">${user.nome || doc.id}</p>
                        <button data-oponente-id="${doc.id}" data-oponente-nome="${user.nome || doc.id}" class="btn-desafiar bg-red-500 text-white font-semibold px-3 py-1 text-sm">Desafiar</button>
                    </div>
                `;
            }
        });
        
        container.innerHTML = usersHTML;
        
        document.querySelectorAll('.btn-desafiar').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const oponenteNome = e.currentTarget.dataset.oponenteNome;
                alert(`Iniciando desafio contra ${oponenteNome}!`);
                
                const q = query(collection(db, "questoes"));
                const snapshot = await getDocs(q);
                let todasQuestoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                todasQuestoes.sort(() => 0.5 - Math.random());
                
                await iniciarSimulado(null, `Desafio vs ${oponenteNome}`, todasQuestoes.slice(0, 5), 'desafio');
            });
        });
    }

    // =========================
    // 11. SIMULADOS DE PROVAS ANTERIORES
    // =========================
    async function carregarSimulados() {
        const container = document.getElementById('lista-simulados');
        container.innerHTML = "<p class='text-slate-500'>Carregando simulados...</p>";
        
        const q = query(collection(db, "simulados"));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            container.innerHTML = "<p class='text-slate-500'>Nenhum simulado de prova anterior encontrado.</p>";
            return;
        }

        container.innerHTML = snapshot.docs.map(doc => {
            const s = doc.data();
            return `
                <div class="border p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-bold">${s.banca} - ${s.ano}</p>
                        <p class="text-slate-600">${s.cargo}</p>
                    </div>
                    <button data-simulado-id="${doc.id}" class="btn-iniciar-simulado-prova bg-purple-600 text-white font-semibold px-4 py-2">Iniciar Simulado</button>
                </div>
            `;
        }).join('');

        document.querySelectorAll('.btn-iniciar-simulado-prova').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const simuladoId = e.currentTarget.dataset.simuladoId;
                const simuladoDoc = await getDoc(doc(db, "simulados", simuladoId));
                if (simuladoDoc.exists()) {
                    const questoesIds = simuladoDoc.data().questoes;
                    const questoesPromises = [];
                    for (let i = 0; i < questoesIds.length; i += 30) {
                        const chunk = questoesIds.slice(i, i + 30);
                        const qQuestoes = query(collection(db, "questoes"), where(documentId(), 'in', chunk));
                        questoesPromises.push(getDocs(qQuestoes));
                    }
                    
                    const questoesSnapshots = await Promise.all(questoesPromises);
                    const questoes = [];
                    questoesSnapshots.forEach(snap => {
                        snap.forEach(d => questoes.push({ id: d.id, ...d.data() }));
                    });

                    iniciarSimulado(null, simuladoDoc.data().nome, questoes, "simulado");
                }
            });
        });
    }

    // =========================
    // 12. REDA√á√ÉO
// =========================

async function carregarTemasRedacao() {
    // Lista est√°tica de temas (pode futuramente vir do Firestore)
    const temas = [
        { titulo: "A influ√™ncia das redes sociais no comportamento juvenil", ano: 2022, banca: "ENEM" },
        { titulo: "Desafios da mobilidade urbana no Brasil", ano: 2021, banca: "Fuvest" },
        { titulo: "O papel da tecnologia na educa√ß√£o contempor√¢nea", ano: 2023, banca: "Unicamp" }
    ];

    const container = document.getElementById("temas-redacao");
    if (!container) return; // Evita erro se o elemento n√£o existir

    container.innerHTML = ""; // Limpa antes de renderizar

    temas.forEach((tema) => {
        const div = document.createElement("div");
        div.className = "p-4 bg-white rounded shadow";

        div.innerHTML = `
            <h3 class="text-lg font-semibold">${tema.titulo}</h3>
            <p class="text-sm text-gray-600">Ano: ${tema.ano} | Banca: ${tema.banca}</p>
            <button class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Escrever Reda√ß√£o
            </button>
        `;

        // Adiciona evento ao bot√£o
        const botao = div.querySelector("button");
        botao.addEventListener("click", () => abrirModalRedacao(tema.titulo));

        container.appendChild(div);
    });
}

  </script>

</body>
</html>

